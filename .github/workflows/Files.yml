name: Sync SuSFS Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  sync-susfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: android15-lineage22-mod
        path: source-repo

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: mozi9/mi
        ref: cs
        path: target-repo

    - name: Setup Git config
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "208763397+mozi9@users.noreply.github.com"

    - name: Check directory structure
      run: |
        echo "=== æ£€æŸ¥ç›®å½•ç»“æ„ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æºä»“åº“ç›®å½•å†…å®¹:"
        ls -la source-repo/
        echo "ç›®æ ‡ä»“åº“ç›®å½•å†…å®¹:"
        ls -la target-repo/
        echo "ç›®æ ‡ä»“åº“driversç›®å½•:"
        ls -la target-repo/drivers/ 2>/dev/null || echo "driversç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º"

    - name: Find and copy files
      run: |
        echo "=== å¼€å§‹æŸ¥æ‰¾å’Œå¤åˆ¶æ–‡ä»¶ ==="
        cd source-repo
        
        # å®šä¹‰è¦æŸ¥æ‰¾çš„æ–‡ä»¶åˆ—è¡¨
        files=(
          "drivers/Makefile"
          "drivers/input/input.c"
          "drivers/tty/pty.c"
          "fs/Makefile"
          "fs/dcache.c"
          "fs/dcache.c.orig"
          "fs/exec.c"
          "fs/namei.c"
          "fs/namei.c.orig"
          "fs/namespace.c"
          "fs/namespace.c.orig"
          "fs/notify/fdinfo.c"
          "fs/open.c"
          "fs/overlayfs/inode.c"
          "fs/overlayfs/readdir.c"
          "fs/overlayfs/super.c"
          "fs/proc/cmdline.c"
          "fs/proc/fd.c"
          "fs/proc/task_mmu.c"
          "fs/proc_namespace.c"
          "fs/read_write.c"
          "fs/readdir.c"
          "fs/stat.c"
          "fs/statfs.c"
          "fs/sus_su.c"
          "fs/susfs.c"
          "include/linux/mount.h"
          "include/linux/sched.h"
          "include/linux/sus_su.h"
          "include/linux/susfs.h"
          "include/linux/susfs_def.h"
          "kernel/kallsyms.c"
          "kernel/sys.c"
        )
        
        copied_count=0
        
        echo "å¼€å§‹æ£€æŸ¥ ${#files[@]} ä¸ªæ–‡ä»¶..."
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file"
            
            # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
            target_dir="$(pwd)/../target-repo/$(dirname "$file")"
            echo "åˆ›å»ºç›®å½•: $target_dir"
            mkdir -p "$target_dir"
            
            # å¤åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
            source_file="$(pwd)/$file"
            echo "å¤åˆ¶: $source_file -> $target_dir/"
            cp "$source_file" "$target_dir/"
            
            ((copied_count++))
            echo "âœ… å¤åˆ¶å®Œæˆ: $file"
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done
        
        echo "========================================"
        echo "ğŸ“Š æ–‡ä»¶å¤åˆ¶ç»Ÿè®¡:"
        echo "âœ… æˆåŠŸå¤åˆ¶: $copied_count ä¸ªæ–‡ä»¶"
        echo "========================================"
        
        if [ $copied_count -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç›®æ ‡æ–‡ä»¶"
          exit 1
        fi

    - name: Verify copied files
      run: |
        echo "=== éªŒè¯å¤åˆ¶çš„æ–‡ä»¶ ==="
        cd target-repo
        
        # æ£€æŸ¥å¤åˆ¶çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "æ£€æŸ¥ç›®æ ‡ä»“åº“ä¸­çš„æ–‡ä»¶:"
        find . -name "*.c" -o -name "*.h" -o -name "Makefile" | head -20
        echo "driversç›®å½•å†…å®¹:"
        ls -la drivers/ 2>/dev/null || echo "driversç›®å½•ä¸å­˜åœ¨"
        echo "fsç›®å½•å†…å®¹:"
        ls -la fs/ 2>/dev/null || echo "fsç›®å½•ä¸å­˜åœ¨"

    - name: Commit and push changes
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        cd target-repo
        
        echo "=== å¼€å§‹æäº¤å’Œæ¨é€ ==="
        
        # æ£€æŸ¥gitçŠ¶æ€
        echo "GitçŠ¶æ€:"
        git status --short
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "âš ï¸  æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªè·Ÿè¸ªçš„æ–‡ä»¶
          if [ -n "$(git ls-files --others --exclude-standard)" ]; then
            echo "å‘ç°æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼Œå°†æ·»åŠ åˆ°git"
            git add .
          else
            echo "æ²¡æœ‰æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
        else
          echo "ğŸ“ æ·»åŠ å˜æ›´æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
          git add .
        fi
        
        echo "ğŸ’¾ åˆ›å»ºæäº¤..."
        git commit -m "fs: Bump SuSFS version to v2.0.0
        
        https://gitlab.com/simonpunk/susfs4ksu/-/commit/b70de6a2f1574a3ac8cb979648f397494391a8a0
        
        Co-authored-by: simonpunk <simonpunk2016@gmail.com>"
        
        echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        GIT_SSH_COMMAND="ssh -i /dev/stdin -o StrictHostKeyChecking=no" git push git@github.com:mozi9/mi.git cs <<< "$SSH_PRIVATE_KEY"
        
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create workflow summary
      if: always()
      run: |
        echo "# åŒæ­¥ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ä»»åŠ¡æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **æºä»“åº“**: YangQi0408/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡ä»“åº“**: mozi9/mi (csåˆ†æ”¯)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¨é€æ–¹å¼**: SSH" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤ä½œè€…**: mozi9" >> $GITHUB_STEP_SUMMARY
