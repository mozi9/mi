name: Sync SuSFS Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  sync-susfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: android15-lineage22-mod
        path: source-repo

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: mozi9/mi
        ref: cs
        path: target-repo

    - name: Setup Git config
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "208763397+mozi9@users.noreply.github.com"

    - name: Copy files one by one with error handling
      run: |
        echo "=== 开始复制文件 ==="
        
        WORKSPACE_DIR="$(pwd)"
        SOURCE_DIR="$WORKSPACE_DIR/source-repo"
        TARGET_DIR="$WORKSPACE_DIR/target-repo"
        
        # 逐个文件处理，避免批量处理中的错误
        copy_file() {
          local file="$1"
          local source_file="$SOURCE_DIR/$file"
          local target_file="$TARGET_DIR/$file"
          local target_dir="$(dirname "$target_file")"
          
          if [ -f "$source_file" ]; then
            echo "复制: $file"
            mkdir -p "$target_dir"
            cp "$source_file" "$target_file"
            return 0
          else
            echo "跳过: $file (文件不存在)"
            return 1
          fi
        }
        
        # 逐个复制文件
        copy_file "drivers/Makefile"
        copy_file "drivers/input/input.c"
        copy_file "drivers/tty/pty.c"
        copy_file "fs/Makefile"
        copy_file "fs/dcache.c"
        copy_file "fs/dcache.c.orig"
        copy_file "fs/exec.c"
        copy_file "fs/namei.c"
        copy_file "fs/namei.c.orig"
        copy_file "fs/namespace.c"
        copy_file "fs/namespace.c.orig"
        copy_file "fs/notify/fdinfo.c"
        copy_file "fs/open.c"
        copy_file "fs/overlayfs/inode.c"
        copy_file "fs/overlayfs/readdir.c"
        copy_file "fs/overlayfs/super.c"
        copy_file "fs/proc/cmdline.c"
        copy_file "fs/proc/fd.c"
        copy_file "fs/proc/task_mmu.c"
        copy_file "fs/proc_namespace.c"
        copy_file "fs/read_write.c"
        copy_file "fs/readdir.c"
        copy_file "fs/stat.c"
        copy_file "fs/statfs.c"
        copy_file "fs/sus_su.c"
        copy_file "fs/susfs.c"
        copy_file "include/linux/mount.h"
        copy_file "include/linux/sched.h"
        copy_file "include/linux/sus_su.h"
        copy_file "include/linux/susfs.h"
        copy_file "include/linux/susfs_def.h"
        copy_file "kernel/kallsyms.c"
        copy_file "kernel/sys.c"
        
        echo "✅ 文件复制过程完成"

    - name: Check if any files were copied
      run: |
        cd target-repo
        echo "=== 检查复制的文件 ==="
        file_count=$(find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | wc -l)
        echo "找到 $file_count 个相关文件"
        
        if [ "$file_count" -eq 0 ]; then
          echo "❌ 没有复制任何文件，任务失败"
          exit 1
        else
          echo "✅ 成功复制 $file_count 个文件"
        fi

    - name: Commit and push changes
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        cd target-repo
        
        echo "=== 提交和推送 ==="
        
        # 检查变更
        if [ -z "$(git status --porcelain)" ]; then
          echo "没有文件变更，跳过提交"
          exit 0
        fi
        
        git add .
        git commit -m "fs: Bump SuSFS version to v2.0.0
        
        https://gitlab.com/simonpunk/susfs4ksu/-/commit/b70de6a2f1574a3ac8cb979648f397494391a8a0
        
        Co-authored-by: simonpunk <simonpunk2016@gmail.com>"
        
        GIT_SSH_COMMAND="ssh -i /dev/stdin -o StrictHostKeyChecking=no" git push git@github.com:mozi9/mi.git cs <<< "$SSH_PRIVATE_KEY"
        
        echo "✅ 推送完成"

    - name: Create summary
      if: always()
      run: |
        echo "同步任务完成" >> $GITHUB_STEP_SUMMARY
