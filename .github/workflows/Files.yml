name: Sync SuSFS Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  sync-susfs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: android15-lineage22-mod
        path: source-repo

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: mozi9/mi
        ref: cs
        path: target-repo

    - name: Setup Git config
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "208763397+mozi9@users.noreply.github.com"

    - name: Copy files with robust error handling
      run: |
        echo "=== å¼€å§‹å¤åˆ¶æ–‡ä»¶ ==="
        set +e  # ç¦ç”¨é”™è¯¯é€€å‡º
        
        WORKSPACE_DIR="$(pwd)"
        SOURCE_DIR="$WORKSPACE_DIR/source-repo"
        TARGET_DIR="$WORKSPACE_DIR/target-repo"
        
        # å®šä¹‰è¦æŸ¥æ‰¾çš„æ–‡ä»¶åˆ—è¡¨
        files=(
          "drivers/Makefile"
          "drivers/input/input.c"
          "drivers/tty/pty.c"
          "fs/Makefile"
          "fs/dcache.c"
          "fs/dcache.c.orig"
          "fs/exec.c"
          "fs/namei.c"
          "fs/namei.c.orig"
          "fs/namespace.c"
          "fs/namespace.c.orig"
          "fs/notify/fdinfo.c"
          "fs/open.c"
          "fs/overlayfs/inode.c"
          "fs/overlayfs/readdir.c"
          "fs/overlayfs/super.c"
          "fs/proc/cmdline.c"
          "fs/proc/fd.c"
          "fs/proc/task_mmu.c"
          "fs/proc_namespace.c"
          "fs/read_write.c"
          "fs/readdir.c"
          "fs/stat.c"
          "fs/statfs.c"
          "fs/sus_su.c"
          "fs/susfs.c"
          "include/linux/mount.h"
          "include/linux/sched.h"
          "include/linux/sus_su.h"
          "include/linux/susfs.h"
          "include/linux/susfs_def.h"
          "kernel/kallsyms.c"
          "kernel/sys.c"
        )
        
        copied_count=0
        not_found_count=0
        
        echo "å¼€å§‹å¤„ç† ${#files[@]} ä¸ªæ–‡ä»¶..."
        
        for file in "${files[@]}"; do
          source_file="$SOURCE_DIR/$file"
          target_file="$TARGET_DIR/$file"
          target_dir="$(dirname "$target_file")"
          
          if [ -f "$source_file" ]; then
            echo "âœ… å¤„ç†: $file"
            mkdir -p "$target_dir"
            if cp "$source_file" "$target_file"; then
              ((copied_count++))
              echo "  å¤åˆ¶æˆåŠŸ"
            else
              echo "  âŒ å¤åˆ¶å¤±è´¥"
            fi
          else
            echo "âŒ è·³è¿‡: $file (æ–‡ä»¶ä¸å­˜åœ¨)"
            ((not_found_count++))
          fi
        done
        
        echo "========================================"
        echo "ğŸ“Š æ–‡ä»¶å¤„ç†ç»Ÿè®¡:"
        echo "âœ… æˆåŠŸå¤åˆ¶: $copied_count ä¸ªæ–‡ä»¶"
        echo "âŒ æœªæ‰¾åˆ°: $not_found_count ä¸ªæ–‡ä»¶"
        echo "========================================"
        
        if [ $copied_count -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æˆåŠŸå¤åˆ¶ä»»ä½•æ–‡ä»¶"
          exit 1
        fi
        
        set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
        exit 0

    - name: Verify copied files
      run: |
        echo "=== éªŒè¯å¤åˆ¶çš„æ–‡ä»¶ ==="
        cd target-repo
        echo "å¤åˆ¶çš„æ–‡ä»¶åˆ—è¡¨:"
        find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | sort
        file_count=$(find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | wc -l)
        echo "æ–‡ä»¶æ€»æ•°: $file_count"

    - name: Commit changes
      run: |
        cd target-repo
        
        echo "=== æäº¤å˜æ›´ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -z "$(git status --porcelain)" ]; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        echo "æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
        git add .
        
        echo "åˆ›å»ºæäº¤..."
        git commit -m "fs: Bump SuSFS version to v2.0.0
        
        https://gitlab.com/simonpunk/susfs4ksu/-/commit/b70de6a2f1574a3ac8cb979648f397494391a8a0
        
        Co-authored-by: simonpunk <simonpunk2016@gmail.com>"
        
        echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"

    - name: Setup SSH environment
      run: |
        echo "=== é…ç½®SSHç¯å¢ƒ ==="
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    - name: Push changes with simple SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        cd target-repo
        
        echo "=== æ¨é€å˜æ›´ ==="
        
        # ç›´æ¥å†™å…¥SSHç§é’¥ï¼ˆä¸è¿›è¡Œä»»ä½•å¤„ç†ï¼‰
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # æ˜¾ç¤ºç§é’¥ä¿¡æ¯ï¼ˆå‰å‡ è¡Œï¼‰
        echo "ç§é’¥æ ¼å¼æ£€æŸ¥:"
        head -3 ~/.ssh/id_rsa
        
        # é…ç½®è¿œç¨‹URLä¸ºSSH
        git remote set-url origin git@github.com:mozi9/mi.git
        
        echo "æµ‹è¯•SSHè¿æ¥..."
        ssh -o ConnectTimeout=10 -T git@github.com 2>&1 | head -3 || true
        
        echo "å¼€å§‹æ¨é€..."
        # ä½¿ç”¨ç®€å•çš„æ¨é€å‘½ä»¤
        GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o ConnectTimeout=30" git push origin cs
        
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Cleanup SSH key
      if: always()
      run: |
        echo "=== æ¸…ç†SSHå¯†é’¥ ==="
        rm -f ~/.ssh/id_rsa
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Create workflow summary
      if: always()
      run: |
        echo "# ğŸš€ SuSFS æ–‡ä»¶åŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“‹ ä»»åŠ¡æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **æºä»“åº“**: YangQi0408/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡ä»“åº“**: mozi9/mi (csåˆ†æ”¯)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¨é€æ–¹å¼**: SSH" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤ä½œè€…**: mozi9" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½œè€…é‚®ç®±**: 208763397+mozi9@users.noreply.github.com" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "fs: Bump SuSFS version to v2.0.0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "https://gitlab.com/simonpunk/susfs4ksu/-/commit/b70de6a2f1574a3ac8cb979648f397494391a8a0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Co-authored-by: simonpunk <simonpunk2016@gmail.com>" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… ä»»åŠ¡çŠ¶æ€: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
