name: Complete File Analysis and Verification

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦åˆ†æçš„åˆ†æ”¯'
        required: true
        default: 'android15-lineage22-mod'

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0

    - name: Analyze file changes in commits
      id: analyze
      run: |
        echo "=== æ­¥éª¤1: åˆ†ææäº¤ä¸­çš„æ–‡ä»¶å˜æ›´ ==="
        
        commits=(
          "b606541dd8ab" "fd23ce0c4773" "c89fb64a7b43" "11e2b4f90ab5" "00ea1bebd156"
          "a3dcd9c96ecf" "8cd00af4573e" "32ac13d80037" "47677a21acaf" "6b06730d311c" "50ce823d8ef5"
        )
        
        # æŒ‰çŠ¶æ€åˆ†ç±»å­˜å‚¨æ–‡ä»¶
        declare -A added_files
        declare -A modified_files
        declare -A deleted_files
        declare -A file_commits
        
        echo "åˆ†æ ${#commits[@]} ä¸ªæäº¤..."
        
        for commit in "${commits[@]}"; do
          echo "åˆ†ææäº¤: $commit"
          
          files=$(git show --name-status --oneline "$commit" 2>/dev/null | tail -n +2)
          
          if [ -z "$files" ]; then
            echo "  âš ï¸ æäº¤æ²¡æœ‰æ–‡ä»¶æˆ–æäº¤ä¸å­˜åœ¨"
            continue
          fi
          
          a_count=0; m_count=0; d_count=0
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            
            status=$(echo "$line" | cut -f1)
            file=$(echo "$line" | cut -f2-)
            [ -z "$file" ] && continue
            
            case "$status" in
              "A")
                added_files["$file"]=1
                ((a_count++))
                echo "  ğŸ†• æ–°å¢: $file"
                ;;
              "M")
                modified_files["$file"]=1
                ((m_count++))
                echo "  âœï¸ ä¿®æ”¹: $file"
                ;;
              "D")
                deleted_files["$file"]=1
                ((d_count++))
                echo "  ğŸ—‘ï¸ åˆ é™¤: $file"
                ;;
            esac
            
            file_commits["$file"]="$commit"
          done <<< "$files"
          
          [ $a_count -gt 0 ] && echo "  æ–°å¢: $a_count"
          [ $m_count -gt 0 ] && echo "  ä¿®æ”¹: $m_count"
          [ $d_count -gt 0 ] && echo "  åˆ é™¤: $d_count"
        done
        
        echo "========================================"
        echo "ğŸ“Š æäº¤åˆ†æç»“æœ:"
        echo "ğŸ†• æ–°å¢æ–‡ä»¶: ${#added_files[@]}"
        echo "âœï¸ ä¿®æ”¹æ–‡ä»¶: ${#modified_files[@]}"
        echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: ${#deleted_files[@]}"
        echo "ğŸ“ æ€»æ–‡ä»¶æ•°: $((${#added_files[@]} + ${#modified_files[@]} + ${#deleted_files[@]}))"
        echo "========================================"
        
        # ä¿å­˜å„çŠ¶æ€æ–‡ä»¶åˆ—è¡¨
        save_file_list() {
          local files_array=("$@")
          local status="$1"
          local filename="$2"
          shift 2
          
          if [ ${#files_array[@]} -gt 0 ]; then
            for file in $(printf "%s\n" "${files_array[@]}" | sort); do
              echo "$file" >> "$filename"
            done
            echo "âœ… å·²ä¿å­˜: $filename (${#files_array[@]} ä¸ªæ–‡ä»¶)"
          else
            echo "âš ï¸ æ²¡æœ‰$statusæ–‡ä»¶"
            touch "$filename"  # åˆ›å»ºç©ºæ–‡ä»¶
          fi
        }
        
        # ä¿å­˜æ–°å¢æ–‡ä»¶åˆ—è¡¨
        printf "%s\n" "${!added_files[@]}" | sort > added_files.txt
        printf "%s\n" "${!modified_files[@]}" | sort > modified_files.txt
        printf "%s\n" "${!deleted_files[@]}" | sort > deleted_files.txt
        
        # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
        echo "added_count=${#added_files[@]}" >> $GITHUB_OUTPUT
        echo "modified_count=${#modified_files[@]}" >> $GITHUB_OUTPUT
        echo "deleted_count=${#deleted_files[@]}" >> $GITHUB_OUTPUT
        echo "total_analyzed=$((${#added_files[@]} + ${#modified_files[@]} + ${#deleted_files[@]}))" >> $GITHUB_OUTPUT

    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: commit-analysis-results
        path: |
          added_files.txt
          modified_files.txt
          deleted_files.txt
        retention-days: 7

  verify-files:
    runs-on: ubuntu-latest
    needs: analyze-commits
    timeout-minutes: 10
    
    steps:
    - name: Download analysis results
      uses: actions/download-artifact@v4
      with:
        name: commit-analysis-results
        path: analysis-results

    - name: Checkout repository for verification
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0

    - name: Verify file existence
      id: verify
      run: |
        echo "=== æ­¥éª¤2: éªŒè¯æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯çš„å­˜åœ¨çŠ¶æ€ ==="
        
        # éªŒè¯æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        verify_files() {
          local file_type="$1"
          local input_file="analysis-results/${file_type}_files.txt"
          local existing_file="existing_${file_type}.txt"
          local missing_file="missing_${file_type}.txt"
          
          if [ ! -s "$input_file" ]; then
            echo "âš ï¸ æ²¡æœ‰${file_type}æ–‡ä»¶éœ€è¦éªŒè¯"
            touch "$existing_file"
            touch "$missing_file"
            return
          fi
          
          existing_count=0
          missing_count=0
          
          echo "éªŒè¯${file_type}æ–‡ä»¶..."
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            if [ -f "$file" ]; then
              echo "âœ… å­˜åœ¨: $file" >> "$existing_file"
              ((existing_count++))
            else
              echo "âŒ ç¼ºå¤±: $file" >> "$missing_file"
              ((missing_count++))
            fi
          done < "$input_file"
          
          echo "ğŸ“Š ${file_type}æ–‡ä»¶éªŒè¯ç»“æœ:"
          echo "  âœ… å­˜åœ¨: $existing_count"
          echo "  âŒ ç¼ºå¤±: $missing_count"
          
          echo "${file_type}_existing=$existing_count" >> $GITHUB_OUTPUT
          echo "${file_type}_missing=$missing_count" >> $GITHUB_OUTPUT
        }
        
        # éªŒè¯åˆ é™¤æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸å­˜åœ¨
        verify_deleted_files() {
          local input_file="analysis-results/deleted_files.txt"
          local actually_deleted_file="actually_deleted.txt"
          local still_exists_file="still_exists.txt"
          
          if [ ! -s "$input_file" ]; then
            echo "âš ï¸ æ²¡æœ‰åˆ é™¤æ–‡ä»¶éœ€è¦éªŒè¯"
            touch "$actually_deleted_file"
            touch "$still_exists_file"
            return
          fi
          
          deleted_count=0
          exists_count=0
          
          echo "éªŒè¯åˆ é™¤æ–‡ä»¶..."
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            if [ ! -f "$file" ]; then
              echo "âœ… å·²åˆ é™¤: $file" >> "$actually_deleted_file"
              ((deleted_count++))
            else
              echo "âš ï¸ æ ‡è®°åˆ é™¤ä½†å­˜åœ¨: $file" >> "$still_exists_file"
              ((exists_count++))
            fi
          done < "$input_file"
          
          echo "ğŸ“Š åˆ é™¤æ–‡ä»¶éªŒè¯ç»“æœ:"
          echo "  âœ… å·²åˆ é™¤: $deleted_count"
          echo "  âš ï¸ ä»å­˜åœ¨: $exists_count"
          
          echo "deleted_verified=$deleted_count" >> $GITHUB_OUTPUT
          echo "deleted_still_exists=$exists_count" >> $GITHUB_OUTPUT
        }
        
        # æ‰§è¡ŒéªŒè¯
        verify_files "added"
        verify_files "modified"
        verify_deleted_files
        
        # ç»Ÿè®¡å½“å‰åˆ†æ”¯æ–‡ä»¶
        echo "=== ç»Ÿè®¡å½“å‰åˆ†æ”¯æ–‡ä»¶ ==="
        all_files=$(find . -type f | wc -l)
        related_files=$(find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | wc -l)
        
        echo "ğŸ“Š å½“å‰åˆ†æ”¯æ–‡ä»¶ç»Ÿè®¡:"
        echo "  ğŸ“ æ€»æ–‡ä»¶æ•°: $all_files"
        echo "  ğŸ”§ ç›¸å…³æ–‡ä»¶æ•°: $related_files"
        
        echo "total_branch_files=$all_files" >> $GITHUB_OUTPUT
        echo "related_files=$related_files" >> $GITHUB_OUTPUT

    - name: Upload verification results
      uses: actions/upload-artifact@v4
      with:
        name: file-verification-results
        path: |
          existing_added.txt
          missing_added.txt
          existing_modified.txt
          missing_modified.txt
          actually_deleted.txt
          still_exists.txt
        retention-days: 7

  generate-report:
    runs-on: ubuntu-latest
    needs: [analyze-commits, verify-files]
    timeout-minutes: 5
    
    steps:
    - name: Download results
      uses: actions/download-artifact@v4
      with:
        name: file-verification-results
        path: verification-results

    - name: Generate comprehensive report
      run: |
        echo "# ğŸ“Š å®Œæ•´æ–‡ä»¶åˆ†æéªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ” åˆ†ææ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æä»“åº“**: YangQi0408/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æåˆ†æ”¯**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææäº¤æ•°**: 11" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“ˆ æäº¤åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ†• æ–°å¢æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.added_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âœï¸ ä¿®æ”¹æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.modified_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“ æ€»åˆ†ææ–‡ä»¶**: ${{ needs.analyze-commits.outputs.total_analyzed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## âœ… æ–‡ä»¶éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "### æ–°å¢æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å­˜åœ¨**: ${{ needs.verify-files.outputs.added_existing }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âŒ ç¼ºå¤±**: ${{ needs.verify-files.outputs.added_missing }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ä¿®æ”¹æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å­˜åœ¨**: ${{ needs.verify-files.outputs.modified_existing }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âŒ ç¼ºå¤±**: ${{ needs.verify-files.outputs.modified_missing }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### åˆ é™¤æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å·²åˆ é™¤**: ${{ needs.verify-files.outputs.deleted_verified }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âš ï¸ ä»å­˜åœ¨**: ${{ needs.verify-files.outputs.deleted_still_exists }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸŒ¿ å½“å‰åˆ†æ”¯çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“ æ€»æ–‡ä»¶æ•°**: ${{ needs.verify-files.outputs.total_branch_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ”§ ç›¸å…³æ–‡ä»¶æ•°**: ${{ needs.verify-files.outputs.related_files }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºåˆ é™¤æ–‡ä»¶åˆ—è¡¨
        if [ -f "verification-results/actually_deleted.txt" ] && [ -s "verification-results/actually_deleted.txt" ]; then
          echo "## ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -30 verification-results/actually_deleted.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          total_deleted=$(wc -l < verification-results/actually_deleted.txt)
          if [ $total_deleted -gt 30 ]; then
            echo "> æ˜¾ç¤ºå‰30ä¸ªåˆ é™¤æ–‡ä»¶ï¼Œå®Œæ•´åˆ—è¡¨è¯·ä¸‹è½½artifact" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "æ²¡æœ‰ç¡®è®¤åˆ é™¤çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºç¼ºå¤±æ–‡ä»¶åˆ—è¡¨
        if [ -f "verification-results/missing_added.txt" ] && [ -s "verification-results/missing_added.txt" ]; then
          echo "## âŒ ç¼ºå¤±çš„æ–°å¢æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 verification-results/missing_added.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "verification-results/missing_modified.txt" ] && [ -s "verification-results/missing_modified.txt" ]; then
          echo "## âŒ ç¼ºå¤±çš„ä¿®æ”¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 verification-results/missing_modified.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¥ ä¸‹è½½è¯¦ç»†ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "å®Œæ•´æ–‡ä»¶åˆ—è¡¨å’ŒéªŒè¯ç»“æœå¯åœ¨Artifactsä¸­ä¸‹è½½:" >> $GITHUB_STEP_SUMMARY
        echo "- **commit-analysis-results**: æäº¤åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- **file-verification-results**: æ–‡ä»¶éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
