name: Detailed Commit File Analysis

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦åˆ†æçš„åˆ†æ”¯'
        required: true
        default: 'android15-lineage22-mod'
  schedule:
    - cron: '0 0 * * 0'

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: ${{ github.event.inputs.branch || 'android15-lineage22-mod' }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: Setup Python and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pygithub

    - name: Get full commit hashes
      id: get-hashes
      run: |
        echo "=== è·å–å®Œæ•´æäº¤å“ˆå¸Œ ==="
        
        # çŸ­å“ˆå¸Œåˆ—è¡¨
        short_hashes=(
          "b606541" "fd23ce0" "c89fb64" "11e2b4f" "00ea1be" 
          "a3dcd9c" "8cd00af" "32ac13d" "47677a2" "6b06730" "50ce823"
        )
        
        full_hashes=()
        hash_mapping=()
        
        for short_hash in "${short_hashes[@]}"; do
          echo "æŸ¥æ‰¾çŸ­å“ˆå¸Œ: $short_hash"
          
          # ä½¿ç”¨gitå‘½ä»¤æŸ¥æ‰¾å®Œæ•´å“ˆå¸Œ
          full_hash=$(git log --oneline | grep "^$short_hash" | head -1 | cut -d' ' -f1 || echo "")
          
          if [ -n "$full_hash" ]; then
            echo "âœ… æ‰¾åˆ°å®Œæ•´å“ˆå¸Œ: $full_hash"
            full_hashes+=("$full_hash")
            hash_mapping+=("$short_hash:$full_hash")
          else
            # å°è¯•ä½¿ç”¨git rev-parse
            full_hash=$(git rev-parse --verify "$short_hash" 2>/dev/null || echo "")
            if [ -n "$full_hash" ]; then
              echo "âœ… æ‰¾åˆ°å®Œæ•´å“ˆå¸Œ: $full_hash"
              full_hashes+=("$full_hash")
              hash_mapping+=("$short_hash:$full_hash")
            else
              echo "âŒ æœªæ‰¾åˆ°å“ˆå¸Œ: $short_hash"
            fi
          fi
        done
        
        # è¾“å‡ºç»“æœ
        echo "full_hashes=$(printf '%s\n' "${full_hashes[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "hash_mapping=$(printf '%s\n' "${hash_mapping[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        
        echo "æ‰¾åˆ°çš„å®Œæ•´å“ˆå¸Œæ•°é‡: ${#full_hashes[@]}"
        echo "å®Œæ•´å“ˆå¸Œåˆ—è¡¨:"
        printf '%s\n' "${full_hashes[@]}"

    - name: Analyze files in commits
      id: analyze-files
      run: |
        echo "=== è¯¦ç»†åˆ†ææäº¤ä¸­çš„æ–‡ä»¶ ==="
        
        # è¯»å–å®Œæ•´å“ˆå¸Œåˆ—è¡¨
        full_hashes=${{ steps.get-hashes.outputs.full_hashes }}
        hashes_array=$(echo "$full_hashes" | jq -r '.[]')
        
        # ç”¨äºå­˜å‚¨æ‰€æœ‰æ–‡ä»¶çš„å­—å…¸
        declare -A all_files
        declare -A file_status
        declare -A file_commits
        declare -A file_commit_messages
        
        echo "å¼€å§‹åˆ†æ ${#hashes_array[@]} ä¸ªæäº¤..."
        
        while IFS= read -r commit_hash; do
          if [ -z "$commit_hash" ]; then
            continue
          fi
          
          echo "åˆ†ææäº¤: $commit_hash"
          
          # è·å–æäº¤ä¿¡æ¯
          commit_message=$(git show -s --format=%s "$commit_hash")
                   commit_author=$(git show -s --format=%an "$commit_hash")
          commit_date=$(git show -s --format=%ci "$commit_hash")
          
          echo "  æäº¤ä¿¡æ¯: $commit_message"
          echo "  ä½œè€…: $commit_author"
          echo "  æ—¥æœŸ: $commit_date"
          
          # è·å–æäº¤çš„æ–‡ä»¶åˆ—è¡¨
          files=$(git show --name-status --oneline "$commit_hash" | tail -n +2)
          
          if [ -z "$files" ]; then
            echo "  âš ï¸ æäº¤æ²¡æœ‰æ–‡ä»¶å˜æ›´"
            continue
          fi
          
          file_count=0
          while IFS= read -r line; do
            if [ -z "$line" ]; then
              continue
            fi
            
            # è§£ææ–‡ä»¶çŠ¶æ€å’Œè·¯å¾„
            status=$(echo "$line" | cut -f1)
            file_path=$(echo "$line" | cut -f2-)
            
            # è·³è¿‡ç©ºè¡Œå’Œå¼‚å¸¸æƒ…å†µ
            if [ -z "$file_path" ] || [ "$file_path" = "" ]; then
              continue
            fi
            
            # è®°å½•æ–‡ä»¶
            all_files["$file_path"]=1
            
            # è®°å½•æ–‡ä»¶çŠ¶æ€ï¼ˆå–æœ€åçš„çŠ¶æ€ï¼‰
            file_status["$file_path"]="$status"
            
            # è®°å½•æ–‡ä»¶å‡ºç°çš„æäº¤
            if [ -z "${file_commits[$file_path]}" ]; then
              file_commits["$file_path"]="$commit_hash"
            else
              file_commits["$file_path"]="${file_commits[$file_path]},$commit_hash"
            fi
            
            # è®°å½•æäº¤ä¿¡æ¯
            file_commit_messages["$file_path"]="$commit_message"
            
            echo "  ğŸ“ $status $file_path"
            ((file_count++))
            
          done <<< "$files"
          
          echo "  æœ¬æäº¤å¤„ç†æ–‡ä»¶æ•°: $file_count"
          
        done <<< "$hashes_array"
        
        echo "åˆ†æå®Œæˆï¼Œå…±æ‰¾åˆ° ${#all_files[@]} ä¸ªå”¯ä¸€æ–‡ä»¶"
        
        # åˆ†ç±»ç»Ÿè®¡
        added_count=0
        modified_count=0
        deleted_count=0
        renamed_count=0
        
        for file in "${!all_files[@]}"; do
          status="${file_status[$file]}"
          case "$status" in
            "A") ((added_count++)) ;;
            "M") ((modified_count++)) ;;
            "D") ((deleted_count++)) ;;
            "R"*) ((renamed_count++)) ;;
          esac
        done
        
        echo "ğŸ“Š æ–‡ä»¶å˜æ›´ç»Ÿè®¡:"
        echo "âœ… æ–°å¢: $added_count"
        echo "âœï¸ ä¿®æ”¹: $modified_count"
        echo "ğŸ—‘ï¸ åˆ é™¤: $deleted_count"
        echo "ğŸ“ é‡å‘½å: $renamed_count"
        
        # ç”Ÿæˆè¯¦ç»†æ–‡ä»¶åˆ—è¡¨
        added_files=()
        modified_files=()
        deleted_files=()
        renamed_files=()
        
        for file in "${!all_files[@]}"; do
          status="${file_status[$file]}"
          commits="${file_commits[$file]}"
          commit_msg="${file_commit_messages[$file]}"
          
          case "$status" in
            "A")
              added_files+=("$file|$commits|$commit_msg")
              ;;
            "M")
              modified_files+=("$file|$commits|$commit_msg")
              ;;
            "D")
              deleted_files+=("$file|$commits|$commit_msg")
              ;;
            "R"*)
              renamed_files+=("$file|$commits|$commit_msg")
              ;;
          esac
        done
        
        # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        echo "added_files=$(printf '%s\n' "${added_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "modified_files=$(printf '%s\n' "${modified_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "deleted_files=$(printf '%s\n' "${deleted_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "renamed_files=$(printf '%s\n' "${renamed_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "total_files=${#all_files[@]}" >> $GITHUB_OUTPUT

    - name: Verify file existence in current branch
      id: verify-files
      run: |
        echo "=== éªŒè¯æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯ä¸­çš„å­˜åœ¨çŠ¶æ€ ==="
        
        # è¯»å–åˆ†æç»“æœ
        added_files=${{ steps.analyze-files.outputs.added_files }}
        modified_files=${{ steps.analyze-files.outputs.modified_files }}
        deleted_files=${{ steps.analyze-files.outputs.deleted_files }}
        
        existing_files=()
        missing_files=()
        actually_deleted=()
        
        # æ£€æŸ¥æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        check_files() {
          local files_json="$1"
          local file_type="$2"
          
          files_array=$(echo "$files_json" | jq -r '.[]')
          
          while IFS= read -r file_entry; do
            if [ -z "$file_entry" ]; then
              continue
            fi
            
            file_path=$(echo "$file_entry" | cut -d'|' -f1)
            commits=$(echo "$file_entry" | cut -d'|' -f2)
            commit_msg=$(echo "$file_entry" | cut -d'|' -f3)
            
            if [ -f "$file_path" ]; then
              echo "âœ… å­˜åœ¨: $file_path ($file_type)"
              existing_files+=("$file_path|$file_type|$commits|$commit_msg")
            else
              echo "âŒ ç¼ºå¤±: $file_path ($file_type)"
              missing_files+=("$file_path|$file_type|$commits|$commit_msg")
            fi
          done <<< "$files_array"
        }
        
        # æ£€æŸ¥åˆ é™¤çš„æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸å­˜åœ¨
        check_deleted_files() {
          local files_json="$1"
          
          files_array=$(echo "$files_json" | jq -r '.[]')
          
          while IFS= read -r file_entry; do
            if [ -z "$file_entry" ]; then
              continue
            fi
            
            file_path=$(echo "$file_entry" | cut -d'|' -f1)
            commits=$(echo "$file_entry" | cut -d'|' -f2)
            commit_msg=$(echo "$file_entry" | cut -d'|' -f3)
            
            if [ ! -f "$file_path" ]; then
              echo "âœ… å·²åˆ é™¤: $file_path"
              actually_deleted+=("$file_path|$commits|$commit_msg")
            else
              echo "âš ï¸ æ ‡è®°åˆ é™¤ä½†å®é™…å­˜åœ¨: $file_path"
            fi
          done <<< "$files_array"
        }
        
        echo "æ£€æŸ¥æ–°å¢æ–‡ä»¶..."
        check_files "$added_files" "æ–°å¢"
        
        echo "æ£€æŸ¥ä¿®æ”¹æ–‡ä»¶..."
        check_files "$modified_files" "ä¿®æ”¹"
        
        echo "æ£€æŸ¥åˆ é™¤æ–‡ä»¶..."
        check_deleted_files "$deleted_files"
        
        # è¾“å‡ºç»“æœ
        echo "existing_files=$(printf '%s\n' "${existing_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "missing_files=$(printf '%s\n' "${missing_files[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
        echo "actually_deleted=$(printf '%s\n' "${actually_deleted[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT

    - name: Count all files in current branch
      id: count-branch-files
      run: |
        echo "=== ç»Ÿè®¡å½“å‰åˆ†æ”¯æ‰€æœ‰æ–‡ä»¶ ==="
        
        # ç»Ÿè®¡æ‰€æœ‰æ–‡ä»¶
        echo "ç»Ÿè®¡æ‰€æœ‰æ–‡ä»¶..."
        all_files=$(find . -type f | wc -l)
        echo "æ€»æ–‡ä»¶æ•°: $all_files"
        
        # ç»Ÿè®¡ç›¸å…³æ–‡ä»¶ç±»å‹
        echo "ç»Ÿè®¡ç›¸å…³æ–‡ä»¶ç±»å‹..."
        c_files=$(find . -name "*.c" | wc -l)
        h_files=$(find . -name "*.h" | wc -l)
        makefiles=$(find . -name "Makefile" | wc -l)
        
        echo "Cæ–‡ä»¶: $c_files"
        echo "å¤´æ–‡ä»¶: $h_files"
        echo "Makefile: $makefiles"
        
        # åˆ—å‡ºæ‰€æœ‰ç›¸å…³æ–‡ä»¶
        echo "åˆ—å‡ºæ‰€æœ‰ç›¸å…³æ–‡ä»¶..."
        related_files=$(find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | sort)
        echo "ç›¸å…³æ–‡ä»¶æ€»æ•°: $(echo "$related_files" | wc -l)"
        
        # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        echo "total_branch_files=$all_files" >> $GITHUB_OUTPUT
        echo "c_files_count=$c_files" >> $GITHUB_OUTPUT
        echo "h_files_count=$h_files" >> $GITHUB_OUTPUT
        echo "makefiles_count=$makefiles" >> $GITHUB_OUTPUT
        echo "related_files_count=$(echo "$related_files" | wc -l)" >> $GITHUB_OUTPUT
        echo "related_files_list=$(echo "$related_files" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT

    - name: Generate comprehensive report
      run: |
        echo "# ğŸ“Š è¯¦ç»†æäº¤æ–‡ä»¶åˆ†ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ” åˆ†ææ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æä»“åº“**: YangQi0408/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æåˆ†æ”¯**: ${{ github.event.inputs.branch || 'android15-lineage22-mod' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææäº¤æ•°**: $(echo '${{ steps.get-hashes.outputs.full_hashes }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“‹ åˆ†æçš„æäº¤" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo '${{ steps.get-hashes.outputs.full_hashes }}' | jq -r '.[]' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“ æäº¤æ–‡ä»¶åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“ˆ æäº¤æ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»åˆ†ææ–‡ä»¶æ•°**: ${{ steps.analyze-files.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ–°å¢æ–‡ä»¶**: $(echo '${{ steps.analyze-files.outputs.added_files }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¿®æ”¹æ–‡ä»¶**: $(echo '${{ steps.analyze-files.outputs.modified_files }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ é™¤æ–‡ä»¶**: $(echo '${{ steps.analyze-files.outputs.deleted_files }}' | jq length)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… å½“å‰å­˜åœ¨çš„æ–‡ä»¶ ($(echo '${{ steps.verify-files.outputs.existing_files }}' | jq length))" >> $GITHUB_STEP_SUMMARY
        existing_array=$(echo '${{ steps.verify-files.outputs.existing_files }}' | jq -r '.[]')
        if [ -n "$existing_array" ]; then
          echo '```' >> $GITHUB_STEP_SUMMARY
          while IFS= read -r entry; do
            if [ -n "$entry" ]; then
              file=$(echo "$entry" | cut -d'|' -f1)
              type=$(echo "$entry" | cut -d'|' -f2)
              echo "$type: $file" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "$existing_array"
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "æ— " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âŒ å½“å‰ç¼ºå¤±çš„æ–‡ä»¶ ($(echo '${{ steps.verify-files.outputs.missing_files }}' | jq length))" >> $GITHUB_STEP_SUMMARY
        missing_array=$(echo '${{ steps.verify-files.outputs.missing_files }}' | jq -r '.[]')
        if [ -n "$missing_array" ]; then
          echo '```' >> $GITHUB_STEP_SUMMARY
          while IFS= read -r entry; do
            if [ -n "$entry" ]; then
              file=$(echo "$entry" | cut -d'|' -f1)
              type=$(echo "$entry" | cut -d'|' -f2)
              echo "$type: $file" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "$missing_array"
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "æ— " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸŒ¿ å½“å‰åˆ†æ”¯æ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š åˆ†æ”¯æ–‡ä»¶æ€»æ•°" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»æ–‡ä»¶æ•°**: ${{ steps.count-branch-files.outputs.total_branch_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cæ–‡ä»¶æ•°**: ${{ steps.count-branch-files.outputs.c_files_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤´æ–‡ä»¶æ•°**: ${{ steps.count-branch-files.outputs.h_files_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Makefileæ•°**: ${{ steps.count-branch-files.outputs.makefiles_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›¸å…³æ–‡ä»¶æ€»æ•°**: ${{ steps.count-branch-files.outputs.related_files_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“ å½“å‰åˆ†æ”¯æ‰€æœ‰ç›¸å…³æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
        echo "å…± ${{ steps.count-branch-files.outputs.related_files_count }} ä¸ªæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo '${{ steps.count-branch-files.outputs.related_files_list }}' | jq -r '.[]' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“ˆ ç»¼åˆåˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æäº¤æ–‡ä»¶è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
        total_analyzed=${{ steps.analyze-files.outputs.total_files }}
        total_existing=$(echo '${{ steps.verify-files.outputs.existing_files }}' | jq length)
        if [ "$total_analyzed" -gt 0 ]; then
          coverage=$(echo "scale=2; $total_existing * 100 / $total_analyzed" | bc)
          echo "- **æäº¤æ–‡ä»¶è¦†ç›–ç‡**: $coverage% ($total_existing/$total_analyzed)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æäº¤æ–‡ä»¶è¦†ç›–ç‡**: 0% (0/0)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### æ–‡ä»¶ç±»å‹åˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
        total_related=${{ steps.count-branch-files.outputs.related_files_count }}
        if [ "$total_related" -gt 0 ]; then
          c_percent=$(echo "scale=2; ${{ steps.count-branch-files.outputs.c_files_count }} * 100 / $total_related" | bc)
          h_percent=$(echo "scale=2; ${{ steps.count-branch-files.outputs.h_files_count }} * 100 / $total_related" | bc)
          mk_percent=$(echo "scale=2; ${{ steps.count-branch-files.outputs.makefiles_count }} * 100 / $total_related" | bc)
          echo "- **Cæ–‡ä»¶å æ¯”**: $c_percent% (${{ steps.count-branch-files.outputs.c_files_count }}/$total_related)" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤´æ–‡ä»¶å æ¯”**: $h_percent% (${{ steps.count-branch-files.outputs.h_files_count }}/$total_related)" >> $GITHUB_STEP_SUMMARY
          echo "- **Makefileå æ¯”**: $mk_percent% (${{ steps.count-branch-files.outputs.makefiles_count }}/$total_related)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## âœ… åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: Save detailed file list to artifact
      uses: actions/upload-artifact@v4
      with:
        name: file-analysis-results
        path: |
          ${{ github.workspace }}/*.txt
        retention-days: 30

    - name: Create detailed file list
      run: |
        echo "=== ç”Ÿæˆè¯¦ç»†æ–‡ä»¶åˆ—è¡¨ ==="
        
        # ç”Ÿæˆå½“å‰åˆ†æ”¯æ‰€æœ‰ç›¸å…³æ–‡ä»¶çš„è¯¦ç»†åˆ—è¡¨
        echo "# å½“å‰åˆ†æ”¯ç›¸å…³æ–‡ä»¶è¯¦ç»†åˆ—è¡¨" > file_list.txt
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> file_list.txt
        echo "åˆ†æ”¯: ${{ github.event.inputs.branch || 'android15-lineage22-mod' }}" >> file_list.txt
        echo "" >> file_list.txt
        
        # æŒ‰ç›®å½•åˆ†ç±»åˆ—å‡ºæ–‡ä»¶
        echo "## æŒ‰ç›®å½•åˆ†ç±»çš„æ–‡ä»¶åˆ—è¡¨" >> file_list.txt
        echo "" >> file_list.txt
        
        # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³æ–‡ä»¶å¹¶æŒ‰ç›®å½•æ’åº
        find . -type f \( -name "*.c" -o -name "*.h" -o -name "Makefile" \) | sed 's|^\./||' | sort > all_related_files.txt
        
        # æŒ‰ç›®å½•åˆ†ç»„
        echo "æŒ‰ç›®å½•ç»Ÿè®¡:" >> file_list.txt
        cat all_related_files.txt | cut -d'/' -f1 | sort | uniq -c | sort -nr >> file_list.txt
        echo "" >> file_list.txt
        
        # åˆ—å‡ºæ¯ä¸ªç›®å½•çš„æ–‡ä»¶
        current_dir=""
        while IFS= read -r file; do
          dir=$(dirname "$file")
          if [ "$dir" != "$current_dir" ]; then
            current_dir="$dir"
            echo "### ç›®å½•: $dir" >> file_list.txt
            echo "" >> file_list.txt
          fi
          echo "- $file" >> file_list.txt
        done < all_related_files.txt
        
        echo "æ–‡ä»¶åˆ—è¡¨å·²ä¿å­˜åˆ° file_list.txt"
        
        # ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
        echo "# æ–‡ä»¶ç»Ÿè®¡æŠ¥å‘Š" > stats.txt
        echo "æ€»æ–‡ä»¶æ•°: ${{ steps.count-branch-files.outputs.total_branch_files }}" >> stats.txt
        echo "Cæ–‡ä»¶æ•°: ${{ steps.count-branch-files.outputs.c_files_count }}" >> stats.txt
        echo "å¤´æ–‡ä»¶æ•°: ${{ steps.count-branch-files.outputs.h_files_count }}" >> stats.txt
        echo "Makefileæ•°: ${{ steps.count-branch-files.outputs.makefiles_count }}" >> stats.txt
        echo "ç›¸å…³æ–‡ä»¶æ€»æ•°: ${{ steps.count-branch-files.outputs.related_files_count }}" >> stats.txt

