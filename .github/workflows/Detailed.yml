name: Complete File Analysis and Verification

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦åˆ†æçš„åˆ†æ”¯'
        required: true
        default: 'android15-lineage22-mod'

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0

    - name: Analyze commits
      id: analyze
      run: |
        echo "=== æ­¥éª¤1: åˆ†ææäº¤ä¸­çš„æ–‡ä»¶å˜æ›´ ==="
        set +e  # ç¦ç”¨é”™è¯¯é€€å‡º
        
        # å®Œæ•´å“ˆå¸Œåˆ—è¡¨
        commits=(
          "b606541dd8ab"
          "fd23ce0c4773"
          "c89fb64a7b43"
          "11e2b4f90ab5"
          "00ea1bebd156"
          "a3dcd9c96ecf"
          "8cd00af4573e"
          "32ac13d80037"
          "47677a21acaf"
          "6b06730d311c"
          "50ce823d8ef5"
        )
        
        # åˆå§‹åŒ–æ•°ç»„
        added_files=()
        modified_files=()
        deleted_files=()
        
        echo "åˆ†æ ${#commits[@]} ä¸ªæäº¤..."
        
        for commit in "${commits[@]}"; do
          echo "åˆ†ææäº¤: $commit"
          
          # æ£€æŸ¥æäº¤æ˜¯å¦å­˜åœ¨
          if ! git rev-parse --verify "$commit" &>/dev/null; then
            echo "  âš ï¸ æäº¤ä¸å­˜åœ¨: $commit"
            continue
          fi
          
          # è·å–æ–‡ä»¶å˜æ›´
          files=$(git show --name-status --oneline "$commit" 2>/dev/null | tail -n +2)
          
          if [ -z "$files" ]; then
            echo "  âš ï¸ æäº¤æ²¡æœ‰æ–‡ä»¶å˜æ›´"
            continue
          fi
          
          # å¤„ç†æ¯ä¸ªæ–‡ä»¶
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            
            status=$(echo "$line" | cut -f1)
            file=$(echo "$line" | cut -f2-)
            [ -z "$file" ] && continue
            
            echo "  ğŸ“ $file ($status)"
            
            # è®°å½•åˆ°å¯¹åº”æ•°ç»„
            case "$status" in
              "A") added_files+=("$file") ;;
              "M") modified_files+=("$file") ;;
              "D") deleted_files+=("$file") ;;
              *) echo "    âš ï¸ æœªçŸ¥çŠ¶æ€: $status" ;;
            esac
          done <<< "$files"
        done
        
        echo "========================================"
        echo "ğŸ“Š åˆ†æç»“æœç»Ÿè®¡:"
        echo "ğŸ†• æ–°å¢æ–‡ä»¶: ${#added_files[@]}"
        echo "âœï¸ ä¿®æ”¹æ–‡ä»¶: ${#modified_files[@]}"
        echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: ${#deleted_files[@]}"
        echo "========================================"
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
        save_unique_files() {
          local arr=("$@")
          local filename="$1"
          shift
          
          printf "%s\n" "${arr[@]}" | sort -u > "$filename"
          echo "âœ… å·²ä¿å­˜: $filename ($(wc -l < "$filename") ä¸ªæ–‡ä»¶)"
        }
        
        save_unique_files "added_files.txt" "${added_files[@]}"
        save_unique_files "modified_files.txt" "${modified_files[@]}"
        save_unique_files "deleted_files.txt" "${deleted_files[@]}"
        
        set -e  # æ¢å¤é”™è¯¯é€€å‡º
        
        # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
        echo "added_count=$(wc -l < added_files.txt)" >> $GITHUB_OUTPUT
        echo "modified_count=$(wc -l < modified_files.txt)" >> $GITHUB_OUTPUT
        echo "deleted_count=$(wc -l < deleted_files.txt)" >> $GITHUB_OUTPUT

    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: commit-analysis-results
        path: |
          added_files.txt
          modified_files.txt
          deleted_files.txt
        retention-days: 7

  verify-files:
    runs-on: ubuntu-latest
    needs: analyze-commits
    timeout-minutes: 10
    
    steps:
    - name: Download analysis results
      uses: actions/download-artifact@v4
      with:
        name: commit-analysis-results
        path: analysis-results

    - name: Checkout repository for verification
      uses: actions/checkout@v4
      with:
        repository: YangQi0408/kernel_xiaomi_sm8250_mod
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0

    - name: Verify file existence
      id: verify
      run: |
        echo "=== æ­¥éª¤2: éªŒè¯æ–‡ä»¶åœ¨å½“å‰åˆ†æ”¯çš„å­˜åœ¨çŠ¶æ€ ==="
        
        # éªŒè¯æ–°å¢æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ğŸ” éªŒè¯æ–°å¢æ–‡ä»¶..."
        if [ -s "analysis-results/added_files.txt" ]; then
          added_existing=0
          added_missing=0
          
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            if [ -f "$file" ]; then
              echo "âœ… æ–°å¢æ–‡ä»¶å­˜åœ¨: $file"
              ((added_existing++))
            else
              echo "âŒ æ–°å¢æ–‡ä»¶ç¼ºå¤±: $file"
              ((added_missing++))
            fi
          done < "analysis-results/added_files.txt"
          
          echo "ğŸ“Š æ–°å¢æ–‡ä»¶éªŒè¯ç»“æœ:"
          echo "  âœ… å­˜åœ¨: $added_existing"
          echo "  âŒ ç¼ºå¤±: $added_missing"
        else
          echo "âš ï¸ æ²¡æœ‰æ–°å¢æ–‡ä»¶éœ€è¦éªŒè¯"
          added_existing=0
          added_missing=0
        fi
        
        # éªŒè¯ä¿®æ”¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo ""
        echo "ğŸ” éªŒè¯ä¿®æ”¹æ–‡ä»¶..."
        if [ -s "analysis-results/modified_files.txt" ]; then
          modified_existing=0
          modified_missing=0
          
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            if [ -f "$file" ]; then
              echo "âœ… ä¿®æ”¹æ–‡ä»¶å­˜åœ¨: $file"
              ((modified_existing++))
            else
              echo "âŒ ä¿®æ”¹æ–‡ä»¶ç¼ºå¤±: $file"
              ((modified_missing++))
            fi
          done < "analysis-results/modified_files.txt"
          
          echo "ğŸ“Š ä¿®æ”¹æ–‡ä»¶éªŒè¯ç»“æœ:"
          echo "  âœ… å­˜åœ¨: $modified_existing"
          echo "  âŒ ç¼ºå¤±: $modified_missing"
        else
          echo "âš ï¸ æ²¡æœ‰ä¿®æ”¹æ–‡ä»¶éœ€è¦éªŒè¯"
          modified_existing=0
          modified_missing=0
        fi
        
        # éªŒè¯åˆ é™¤æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸å­˜åœ¨
        echo ""
        echo "ğŸ” éªŒè¯åˆ é™¤æ–‡ä»¶..."
        if [ -s "analysis-results/deleted_files.txt" ]; then
          deleted_verified=0
          deleted_still_exists=0
          
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            if [ ! -f "$file" ]; then
              echo "âœ… ç¡®è®¤å·²åˆ é™¤: $file"
              ((deleted_verified++))
            else
              echo "âš ï¸ æ ‡è®°åˆ é™¤ä½†å­˜åœ¨: $file"
              ((deleted_still_exists++))
            fi
          done < "analysis-results/deleted_files.txt"
          
          echo "ğŸ“Š åˆ é™¤æ–‡ä»¶éªŒè¯ç»“æœ:"
          echo "  âœ… å·²åˆ é™¤: $deleted_verified"
          echo "  âš ï¸ ä»å­˜åœ¨: $deleted_still_exists"
        else
          echo "âš ï¸ æ²¡æœ‰åˆ é™¤æ–‡ä»¶éœ€è¦éªŒè¯"
          deleted_verified=0
          deleted_still_exists=0
        fi
        
        # ç»Ÿè®¡å½“å‰åˆ†æ”¯æ–‡ä»¶
        echo ""
        echo "=== ç»Ÿè®¡å½“å‰åˆ†æ”¯æ–‡ä»¶ ==="
        all_files=$(find . -type f | wc -l)
        c_files=$(find . -name "*.c" | wc -l)
        h_files=$(find . -name "*.h" | wc -l)
        makefiles=$(find . -name "Makefile" | wc -l)
        related_files=$((c_files + h_files + makefiles))
        
        echo "ğŸ“Š å½“å‰åˆ†æ”¯æ–‡ä»¶ç»Ÿè®¡:"
        echo "  ğŸ“ æ€»æ–‡ä»¶æ•°: $all_files"
        echo "  ğŸ”§ ç›¸å…³æ–‡ä»¶æ•°: $related_files"
        echo "    - Cæ–‡ä»¶: $c_files"
        echo "    - å¤´æ–‡ä»¶: $h_files"
        echo "    - Makefile: $makefiles"
        
        # è¾“å‡ºéªŒè¯ç»“æœ
        echo "added_existing=$added_existing" >> $GITHUB_OUTPUT
        echo "added_missing=$added_missing" >> $GITHUB_OUTPUT
        echo "modified_existing=$modified_existing" >> $GITHUB_OUTPUT
        echo "modified_missing=$modified_missing" >> $GITHUB_OUTPUT
        echo "deleted_verified=$deleted_verified" >> $GITHUB_OUTPUT
        echo "deleted_still_exists=$deleted_still_exists" >> $GITHUB_OUTPUT
        echo "total_branch_files=$all_files" >> $GITHUB_OUTPUT
        echo "related_files=$related_files" >> $GITHUB_OUTPUT

    - name: Upload verification results
      uses: actions/upload-artifact@v4
      with:
        name: file-verification-results
        path: analysis-results/
        retention-days: 7

  generate-report:
    runs-on: ubuntu-latest
    needs: [analyze-commits, verify-files]
    timeout-minutes: 5
    
    steps:
    - name: Download results
      uses: actions/download-artifact@v4
      with:
        name: commit-analysis-results
        path: analysis-results

    - name: Generate comprehensive report
      run: |
        echo "# ğŸ“Š å®Œæ•´æ–‡ä»¶åˆ†æéªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ” åˆ†ææ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æä»“åº“**: YangQi0408/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æåˆ†æ”¯**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææäº¤æ•°**: 11" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†ææ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“ˆ æäº¤åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ†• æ–°å¢æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.added_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âœï¸ ä¿®æ”¹æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.modified_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶**: ${{ needs.analyze-commits.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## âœ… æ–‡ä»¶éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "### æ–°å¢æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å­˜åœ¨**: ${{ needs.verify-files.outputs.added_existing }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âŒ ç¼ºå¤±**: ${{ needs.verify-files.outputs.added_missing }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ä¿®æ”¹æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å­˜åœ¨**: ${{ needs.verify-files.outputs.modified_existing }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âŒ ç¼ºå¤±**: ${{ needs.verify-files.outputs.modified_missing }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### åˆ é™¤æ–‡ä»¶éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- **âœ… å·²åˆ é™¤**: ${{ needs.verify-files.outputs.deleted_verified }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âš ï¸ ä»å­˜åœ¨**: ${{ needs.verify-files.outputs.deleted_still_exists }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸŒ¿ å½“å‰åˆ†æ”¯çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“ æ€»æ–‡ä»¶æ•°**: ${{ needs.verify-files.outputs.total_branch_files }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ”§ ç›¸å…³æ–‡ä»¶æ•°**: ${{ needs.verify-files.outputs.related_files }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºåˆ é™¤æ–‡ä»¶åˆ—è¡¨
        if [ -f "analysis-results/deleted_files.txt" ] && [ -s "analysis-results/deleted_files.txt" ]; then
          echo "## ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          echo "å…± ${{ needs.analyze-commits.outputs.deleted_count }} ä¸ªæ–‡ä»¶è¢«æ ‡è®°ä¸ºåˆ é™¤:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -30 analysis-results/deleted_files.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          if [ ${{ needs.analyze-commits.outputs.deleted_count }} -gt 30 ]; then
            echo "> æ˜¾ç¤ºå‰30ä¸ªåˆ é™¤æ–‡ä»¶ï¼Œå®Œæ•´åˆ—è¡¨è¯·ä¸‹è½½artifact" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "æ²¡æœ‰æ‰¾åˆ°è¢«åˆ é™¤çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºç¡®è®¤åˆ é™¤çš„æ–‡ä»¶
        if [ ${{ needs.verify-files.outputs.deleted_verified }} -gt 0 ]; then
          echo "## âœ… ç¡®è®¤åˆ é™¤çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "**${{ needs.verify-files.outputs.deleted_verified }} ä¸ªæ–‡ä»¶å·²ç¡®è®¤åˆ é™¤**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ ${{ needs.verify-files.outputs.deleted_still_exists }} -gt 0 ]; then
          echo "## âš ï¸ æ ‡è®°åˆ é™¤ä½†å­˜åœ¨çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "**${{ needs.verify-files.outputs.deleted_still_exists }} ä¸ªæ–‡ä»¶æ ‡è®°ä¸ºåˆ é™¤ä½†å®é™…å­˜åœ¨**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¥ ä¸‹è½½è¯¦ç»†ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "å®Œæ•´æ–‡ä»¶åˆ—è¡¨å¯åœ¨Artifactsä¸­ä¸‹è½½:" >> $GITHUB_STEP_SUMMARY
        echo "- **commit-analysis-results**: æäº¤åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "- **file-verification-results**: æ–‡ä»¶éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
