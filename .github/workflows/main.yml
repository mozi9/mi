name: Sync Repository Files

on:
  workflow_dispatch:

jobs:
  sync-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.MOZI9_SSH_KEY }}
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: mozi9/mi
          ref: cs
          ssh-key: ${{ secrets.MOZI9_SSH_KEY }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Get file list with detailed logging
        id: get-files
        run: |
          pip install requests
          
          python << 'EOF'
          import requests
          import os
          import json
          
          source_repo = "ApartTUSITU/kernel_xiaomi_sm8250_mod"
          commit_hash = "75fef37"
          
          print("ðŸ” Fetching file list from source repository...")
          print(f"ðŸ“ Repository: {source_repo}")
          print(f"ðŸ”– Commit: {commit_hash}")
          
          url = f"https://api.github.com/repos/{source_repo}/commits/{commit_hash}"
          response = requests.get(url)
          
          if response.status_code == 200:
              commit_data = response.json()
              files = [file['filename'] for file in commit_data['files']]
              
              print(f"âœ… Found {len(files)} files in the commit:")
              for i, file in enumerate(files, 1):
                  print(f"  {i:2d}. {file}")
              
              # å°†æ–‡ä»¶åˆ—è¡¨å†™å…¥çŽ¯å¢ƒå˜é‡
              files_json = json.dumps(files)
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  fh.write(f'file_list={files_json}\n')
              
              print(f"ðŸ“‹ File list prepared for processing")
          else:
              print(f"âŒ Error fetching commit: {response.status_code}")
              print(f"Response: {response.text}")
              exit(1)
          EOF
          
      - name: Delete files with detailed logging
        id: delete-files
        run: |
          echo "ðŸ—‘ï¸ Starting file deletion process..."
          echo "========================================"
          
          python << 'EOF'
          import json
          import os
          
          # ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–æ–‡ä»¶åˆ—è¡¨
          files_json = '''${{ steps.get-files.outputs.file_list }}'''
          files = json.loads(files_json)
          
          deleted_files = []
          not_found_files = []
          error_files = []
          
          print("ðŸ“‹ Processing file list:")
          print("=" * 60)
          
          for i, file_path in enumerate(files, 1):
              if not file_path:
                  continue
                  
              print(f"{i:2d}. {file_path}")
              
              if os.path.isfile(file_path):
                  try:
                      # æ£€æŸ¥æ–‡ä»¶å¤§å°ç­‰ä¿¡æ¯
                      file_size = os.path.getsize(file_path)
                      os.remove(file_path)
                      print(f"    âœ… DELETED (size: {file_size} bytes)")
                      deleted_files.append(file_path)
                  except Exception as e:
                      print(f"    âŒ ERROR: {e}")
                      error_files.append(f"{file_path} - {e}")
              else:
                  print(f"    âš ï¸  NOT FOUND")
                  not_found_files.append(file_path)
          
          print("=" * 60)
          print("ðŸ“Š DELETION SUMMARY:")
          print(f"âœ… Successfully deleted: {len(deleted_files)} files")
          print(f"âš ï¸  Not found: {len(not_found_files)} files")
          print(f"âŒ Errors: {len(error_files)} files")
          
          # è¾“å‡ºè¯¦ç»†åˆ—è¡¨
          if deleted_files:
              print("\nðŸ“ DELETED FILES:")
              for file in deleted_files:
                  print(f"  â€¢ {file}")
          
          if not_found_files:
              print("\nðŸ” FILES NOT FOUND:")
              for file in not_found_files:
                  print(f"  â€¢ {file}")
          
          if error_files:
              print("\nðŸš« ERRORS:")
              for error in error_files:
                  print(f"  â€¢ {error}")
          
          # å†™å…¥è¾“å‡ºå˜é‡
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f'deleted={len(deleted_files)}\n')
              fh.write(f'not_found={len(not_found_files)}\n')
              fh.write(f'error_count={len(error_files)}\n')
              fh.write(f'deleted_files={json.dumps(deleted_files)}\n')
              fh.write(f'not_found_files={json.dumps(not_found_files)}\n')
              fh.write(f'error_files={json.dumps(error_files)}\n')
          EOF
          
      - name: Check Git status
        if: steps.delete-files.outputs.deleted > 0
        run: |
          echo "ðŸ“Š Git status before commit:"
          echo "============================"
          git status --short
          echo ""
          
          echo "ðŸ“‹ Files to be committed:"
          git diff --cached --name-status || echo "No changes staged"
          
      - name: Commit changes (ç®€æ´æäº¤ä¿¡æ¯)
        if: steps.delete-files.outputs.deleted > 0
        run: |
          echo "ðŸ’¾ Staging changes..."
          git add -A
          
          echo "ðŸ“ Committing withç®€æ´ä¿¡æ¯..."
          git commit -m "KSU: Remove KSU and SUSFS"
          
          echo "âœ… Commit created:"
          git log --oneline -1
          
      - name: Push changes
        if: steps.delete-files.outputs.deleted > 0
        run: |
          echo "ðŸš€ Pushing to cs branch..."
          git push origin cs
          echo "âœ… Push completed successfully!"
          
      - name: Create detailed workflow summary
        run: |
          echo "## ðŸ”„ File Sync Operation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Operation Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Repository:** ApartTUSITU/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Hash:** 75fef37" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branch:** cs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ˆ File Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Deleted | ${{ steps.delete-files.outputs.deleted || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Not Found | ${{ steps.delete-files.outputs.not_found || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Errors | ${{ steps.delete-files.outputs.error_count || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºè¯¦ç»†æ–‡ä»¶åˆ—è¡¨
          python << 'EOF'
          import json
          import os
          
          deleted_files = json.loads('''${{ steps.delete-files.outputs.deleted_files }}''') if '''${{ steps.delete-files.outputs.deleted_files }}''' else []
          not_found_files = json.loads('''${{ steps.delete-files.outputs.not_found_files }}''') if '''${{ steps.delete-files.outputs.not_found_files }}''' else []
          
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              if deleted_files:
                  f.write("### âœ… Successfully Deleted Files\\n")
                  f.write("```\\n")
                  for file in deleted_files:
                      f.write(f"{file}\\n")
                  f.write("```\\n\\n")
              
              if not_found_files:
                  f.write("### âš ï¸ Files Not Found (Already Missing)\\n")
                  f.write("```\\n")
                  for file in not_found_files:
                      f.write(f"{file}\\n")
                  f.write("```\\n\\n")
          EOF
          
          if [ "${{ steps.delete-files.outputs.deleted || 0 }}" -gt 0 ]; then
            echo "### ðŸš€ Push Status" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Changes successfully pushed to **cs** branch" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commit Message:** KSU: Remove KSU and SUSFS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Status" >> $GITHUB_STEP_SUMMARY
            echo "No files were deleted in this operation" >> $GITHUB_STEP_SUMMARY
          fi
