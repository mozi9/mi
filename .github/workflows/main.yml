name: Sync Repository Files

on:
  workflow_dispatch:

jobs:
  sync-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: mozi9/mi
          ref: cs
          token: ${{ secrets.MOZI9_TOKEN }}
          fetch-depth: 0  # 获取完整历史
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Get file list from source
        env:
          GITHUB_TOKEN: ${{ secrets.MOZI9_TOKEN }}
        run: |
          pip install requests
          
          python << 'EOF'
          import requests
          import os
          
          source_repo = "ApartTUSITU/kernel_xiaomi_sm8250_mod"
          commit_hash = "75fef37"
          
          # 直接获取提交信息
          url = f"https://api.github.com/repos/{source_repo}/commits/{commit_hash}"
          headers = {"Authorization": f"token {os.getenv('GITHUB_TOKEN')}"}
          
          response = requests.get(url, headers=headers)
          if response.status_code == 200:
              commit_data = response.json()
              files = [file['filename'] for file in commit_data['files']]
              
              with open('file_list.txt', 'w') as f:
                  for file_path in files:
                      f.write(file_path + '\n')
              
              print(f"Found {len(files)} files")
          else:
              print(f"Error: {response.status_code}")
              exit(1)
          EOF
          
      - name: Delete files
        id: delete-files
        run: |
          deleted=0
          not_found=0
          
          if [ -f file_list.txt ]; then
              while IFS= read -r file; do
                  if [ -f "$file" ]; then
                      rm -f "$file" && ((deleted++)) || echo "Error: $file"
                  else
                      ((not_found++))
                  fi
              done < file_list.txt
          fi
          
          echo "deleted=$deleted" >> $GITHUB_OUTPUT
          echo "not_found=$not_found" >> $GITHUB_OUTPUT
          echo "Deleted: $deleted, Not found: $not_found"
          
      - name: Commit and push
        if: steps.delete-files.outputs.deleted > 0
        run: |
          git config user.name "mozi9"
          git config user.email "mozi9@users.noreply.github.com"
          git add -A
          git commit -m "Remove KSU and SUSFS"
          git push origin cs
