name: Sync Repository Files

on:
  workflow_dispatch:

jobs:
  sync-files:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 使用 webfactory/ssh-agent 来管理 SSH 密钥（推荐方式）
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.mozi9 }}
      
      # 2. 检出代码（使用 SSH 方式）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: mozi9/mi
          ref: cs
          # 使用 SSH 方式检出
          token: ${{ secrets.GITHUB_TOKEN }}  # 用于 API 调用，SSH 用于传输
          ssh-key: ${{ secrets.mozi9 }}
          
      # 3. 配置 Git 使用 SSH 协议
      - name: Configure Git for SSH
        run: |
          git config user.name "mozi9"
          git config user.email "mozi9@users.noreply.github.com"
          git remote set-url origin git@github.com:mozi9/mi.git
          
      # 4. 测试 SSH 连接
      - name: Test SSH connection
        run: |
          ssh -T git@github.com || true
          
      # 5. 设置 Python 环境
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      # 6. 获取文件列表
      - name: Get file list from source
        run: |
          pip install requests
          
          python << 'EOF'
          import requests
          
          source_repo = "ApartTUSITU/kernel_xiaomi_sm8250_mod"
          commit_hash = "75fef37"
          
          url = f"https://api.github.com/repos/{source_repo}/commits/{commit_hash}"
          response = requests.get(url)
          
          if response.status_code == 200:
              commit_data = response.json()
              files = [file['filename'] for file in commit_data['files']]
              
              with open('file_list.txt', 'w') as f:
                  for file_path in files:
                      f.write(file_path + '\n')
              
              print(f"Found {len(files)} files")
          else:
              print(f"Error: {response.status_code}")
              exit(1)
          EOF
          
      # 7. 删除文件
      - name: Delete files
        id: delete-files
        run: |
          set +e  # 禁用严格错误模式
          deleted=0
          not_found=0
          error_count=0
          
          echo "=== Starting file deletion ==="
          
          if [ -f file_list.txt ]; then
              while IFS= read -r file; do
                  # 跳过空行
                  [ -z "$file" ] && continue
                  
                  echo "Processing: $file"
                  
                  if [ -f "$file" ]; then
                      if rm -f "$file"; then
                          echo "✅ Deleted: $file"
                          deleted=$((deleted + 1))
                      else
                          echo "❌ Error deleting: $file"
                          error_count=$((error_count + 1))
                      fi
                  else
                      echo "⚠️ Not found: $file"
                      not_found=$((not_found + 1))
                  fi
              done < file_list.txt
          else
              echo "❌ file_list.txt not found"
              exit 1
          fi
          
          echo "deleted=$deleted" >> $GITHUB_OUTPUT
          echo "not_found=$not_found" >> $GITHUB_OUTPUT
          echo "error_count=$error_count" >> $GITHUB_OUTPUT
          
          echo "=== Summary ==="
          echo "Deleted: $deleted"
          echo "Not found: $not_found"
          echo "Errors: $error_count"
          
      # 8. 提交并推送更改
      - name: Commit and push changes
        if: steps.delete-files.outputs.deleted > 0
        run: |
          # 检查是否有更改
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # 添加所有更改
          git add -A
          
          # 提交更改
          git commit -m "KSU: Remove KSU and SUSFS"
          
          # 推送更改（使用 SSH）
          echo "Pushing to cs branch..."
          git push origin cs
          
          echo "✅ Push completed successfully"
          
      # 9. 创建摘要报告
      - name: Create summary
        run: |
          echo "## File Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Repository:** ApartTUSITU/kernel_xiaomi_sm8250_mod" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Hash:** 75fef37" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** cs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ **Deleted files:** ${{ steps.delete-files.outputs.deleted }}" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️ **Files not found:** ${{ steps.delete-files.outputs.not_found }}" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ **Errors:** ${{ steps.delete-files.outputs.error_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.delete-files.outputs.deleted }}" -gt 0 ]; then
            echo "✅ Changes successfully pushed to **cs** branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No files were deleted" >> $GITHUB_STEP_SUMMARY
          fi
