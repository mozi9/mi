name: Create Branch via API

on:
  workflow_dispatch:

jobs:
  create-branch:
    runs-on: ubuntu-latest

    steps:
    - name: Get latest commit SHA
      id: get-commit
      run: |
        COMMIT_SHA=$(curl -s -H "Authorization: token ${{ secrets.MOZI9 }}" \
          "https://api.github.com/repos/mozi9/mi/git/refs/heads/cc" | \
          jq -r '.object.sha')
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "Source commit SHA: $COMMIT_SHA"

    - name: Create branch via API
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.MOZI9 }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/mozi9/kernel_xiaomi_sm8250/git/refs" \
          -d '{
            "ref": "refs/heads/cs",
            "sha": "${{ steps.get-commit.outputs.commit_sha }}"
          }'
        echo "✅ 通过API创建分支完成"

    - name: Verify branch creation
      run: |
        curl -s -H "Authorization: token ${{ secrets.MOZI9 }}" \
          "https://api.github.com/repos/mozi9/kernel_xiaomi_sm8250/branches/cs" | \
          jq '{name: .name, commit: .commit.sha}'
