name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clean workspace
      run: |
        rm -rf out/ anykernel/ *.zip .dts.bak/
        find . -name "*.o" -delete 2>/dev/null || true
        find . -name "*.cmd" -delete 2>/dev/null || true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3

    - name: Setup toolchain
      run: |
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        cd $GITHUB_WORKSPACE

    - name: Build kernel
      run: |
        set -e
        
        # è®¾ç½®ç¯å¢ƒ
        export PATH="$HOME/zyc-clang/bin:$PATH"
        
        # æ„å»ºå‚æ•°
        BUILD_ARGS="${{ github.event.inputs.device }}"
        [ "${{ github.event.inputs.include_ksu }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS ksu"
        [ "${{ github.event.inputs.build_type }}" = "aosp" ] && BUILD_ARGS="$BUILD_ARGS --aosp"
        [ "${{ github.event.inputs.build_type }}" = "miui" ] && BUILD_ARGS="$BUILD_ARGS --miui"
        [ "${{ github.event.inputs.build_type }}" = "all" ] && BUILD_ARGS="$BUILD_ARGS --aosp --miui"
        
        chmod +x ./build.sh
        
        # æ‰§è¡Œæ„å»º
        if ! ./build.sh $BUILD_ARGS 2>&1 | tee build.log; then
          echo "âŒ æ„å»ºå¤±è´¥"
          
          # åˆ†æé”™è¯¯
          CONFLICT_FILES=(
            "drivers/Makefile" "drivers/input/input.c" "drivers/tty/pty.c"
            "fs/Makefile" "fs/dcache.c" "fs/exec.c" "fs/namei.c" "fs/namespace.c"
            "fs/notify/fdinfo.c" "fs/open.c" "fs/overlayfs/inode.c" "fs/overlayfs/readdir.c"
            "fs/overlayfs/super.c" "fs/proc/cmdline.c" "fs/proc/fd.c" "fs/proc/task_mmu.c"
            "fs/proc_namespace.c" "fs/read_write.c" "fs/readdir.c" "fs/stat.c"
            "fs/statfs.c" "fs/susfs.c" "include/linux/mount.h" "include/linux/sched.h"
            "include/linux/susfs.h" "include/linux/susfs_def.h" "kernel/kallsyms.c"
            "kernel/sys.c" "security/selinux/avc.c"
          )
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯æ¨¡å¼
          echo "ğŸ” é”™è¯¯åˆ†æ:"
          
          # Gitå†²çª
          if grep -q "<<<<<<<" build.log; then
            echo "âŒ Gitå†²çª:"
            grep -B2 -A2 "<<<<<<<" build.log | head -5
          fi
          
          # æ–‡ä»¶ç›¸å…³é”™è¯¯
          for file in "${CONFLICT_FILES[@]}"; do
            if grep -q "$file" build.log; then
              echo "ğŸ“„ $file ç›¸å…³é”™è¯¯:"
              grep -A3 -B1 "$file" build.log | head -5
              
              # æ£€æŸ¥æ–‡ä»¶ä¸­çš„å†²çªæ ‡è®°
              if [ -f "$file" ] && grep -q "<<<<<<<" "$file"; then
                echo "  âš ï¸ æ–‡ä»¶å­˜åœ¨Gitå†²çªæ ‡è®°"
                grep -n "<<<<<<<" "$file" | head -2
              fi
            fi
          done
          
          # å¸¸è§é”™è¯¯ç±»å‹
          grep -E "error:|undefined reference|conflicting types" build.log | head -10 | while read error; do
            echo "ğŸ’¥ $error"
          done
          
          # æ˜¾ç¤ºé”™è¯¯æ–‡ä»¶å’Œè¡Œå·
          echo "ğŸ“ é”™è¯¯ä½ç½®:"
          grep -E ":[0-9]+:[0-9]+:" build.log | head -5 | while read line; do
            file=$(echo "$line" | cut -d: -f1)
            line_num=$(echo "$line" | cut -d: -f2)
            echo "  $file:$line_num"
          done
          
          exit 1
        fi
        
        echo "âœ… æ„å»ºæˆåŠŸ"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}
        path: "*.zip"
        retention-days: 7
