name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3 tar

    # ç”ŸæˆçŸ­å“ˆå¸Œ
    - name: Set short commit SHA
      run: echo "SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache_mikernel
        key: ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-${{ env.SHORT_SHA }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-
          ${{ runner.os }}-ccache-

    - name: Setup zyc-clang toolchain
      run: |
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        cd $GITHUB_WORKSPACE

    - name: Build kernel
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export TOOLCHAIN_PATH="$HOME/zyc-clang"
        export PATH="$HOME/zyc-clang/bin:$PATH"
        
        # æ„å»ºå‘½ä»¤å‚æ•°
        BUILD_CMD="./build.sh ${{ github.event.inputs.device }}"
        
        # æ·»åŠ KSUå‚æ•°
        if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
          BUILD_CMD="$BUILD_CMD ksu"
        fi
        
        # æ·»åŠ æ„å»ºç±»å‹å‚æ•°
        if [ "${{ github.event.inputs.build_type }}" = "aosp" ]; then
          BUILD_CMD="$BUILD_CMD --aosp"
        elif [ "${{ github.event.inputs.build_type }}" = "miui" ]; then
          BUILD_CMD="$BUILD_CMD --miui"
        fi
        
        echo "æ„å»ºé…ç½®:"
        echo "è®¾å¤‡: ${{ github.event.inputs.device }}"
        echo "ç±»å‹: ${{ github.event.inputs.build_type }}"
        echo "KSU: ${{ github.event.inputs.include_ksu }}"
        echo "å‘½ä»¤: $BUILD_CMD"
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        if [ ! -f "./build.sh" ]; then
          echo "âŒ é”™è¯¯: build.sh æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        chmod +x ./build.sh
        
        # æ‰§è¡Œæ„å»ºå¹¶æ•è·è¯¦ç»†é”™è¯¯ä¿¡æ¯
        echo "ğŸš€ å¼€å§‹æ„å»ºå†…æ ¸..."
        set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
        $BUILD_CMD || {
          echo "âŒ æ„å»ºå¤±è´¥ï¼é”™è¯¯ä»£ç : $?"
          echo "ğŸ“‹ æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„é—®é¢˜:"
          echo "   - è®¾å¤‡é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "   - ä¾èµ–æ˜¯å¦å®Œæ•´å®‰è£…"
          echo "   - å·¥å…·é“¾æ˜¯å¦è®¾ç½®æ­£ç¡®"
          exit 1
        }

    - name: Show ccache stats
      run: ccache -s

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}-kernel
        path: |
          *.zip
        retention-days: 7

    - name: Upload build logs (ä»…å¤±è´¥æ—¶)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.device }}-build-logs
        path: |
          out/
          anykernel/
        retention-days: 3
