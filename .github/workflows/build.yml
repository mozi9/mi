name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # æ”¹ä¸º0è·å–å®Œæ•´å†å²ï¼Œé¿å…æµ…å…‹éš†é—®é¢˜

    - name: Clean workspace
      run: |
        rm -rf out/ anykernel/ *.zip .dts.bak/
        find . -name "*.o" -delete 2>/dev/null || true
        find . -name "*.cmd" -delete 2>/dev/null || true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3 libelf-dev

    - name: Setup toolchain
      run: |
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        # è®¾ç½®æ­£ç¡®çš„å·¥å…·é“¾è·¯å¾„
        export TOOLCHAIN_PATH="$HOME/zyc-clang"
        echo "TOOLCHAIN_PATH=$TOOLCHAIN_PATH" >> $GITHUB_ENV

    - name: Build kernel
      run: |
        set -e
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PATH="$HOME/zyc-clang/bin:$PATH"
        export TOOLCHAIN_PATH="$HOME/zyc-clang"
        export CCACHE_DIR="$HOME/.cache/ccache_mikernel"
        
        # åˆ›å»ºccacheç›®å½•
        mkdir -p $CCACHE_DIR
        
        # æ„å»ºå‚æ•°
        BUILD_ARGS="${{ github.event.inputs.device }}"
        [ "${{ github.event.inputs.include_ksu }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS ksu"
        
        # æ ¹æ®æ„å»ºç±»å‹è®¾ç½®å‚æ•°
        case "${{ github.event.inputs.build_type }}" in
          "aosp") BUILD_ARGS="$BUILD_ARGS --aosp" ;;
          "miui") BUILD_ARGS="$BUILD_ARGS --miui" ;;
          "all") BUILD_ARGS="$BUILD_ARGS --aosp --miui" ;;
        esac
        
        echo "æ„å»ºå‚æ•°: $BUILD_ARGS"
        
        # ç»™æ„å»ºè„šæœ¬æ‰§è¡Œæƒé™
        chmod +x ./build.sh
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "./build.sh" ]; then
          echo "âŒ æ„å»ºè„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ‰§è¡Œæ„å»º
        echo "ğŸš€ å¼€å§‹æ„å»ºå†…æ ¸..."
        if ./build.sh $BUILD_ARGS; then
          echo "âœ… æ„å»ºæˆåŠŸ"
          
          # æ£€æŸ¥ç”Ÿæˆçš„zipæ–‡ä»¶
          echo "ğŸ“¦ æ£€æŸ¥ç”Ÿæˆçš„åˆ·æœºåŒ…:"
          ls -la *.zip || echo "âš  æœªæ‰¾åˆ°zipæ–‡ä»¶"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          
          # é”™è¯¯åˆ†æ
          echo "ğŸ” é”™è¯¯åˆ†æ:"
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯
          if [ -f "build.log" ]; then
            echo "æ„å»ºæ—¥å¿—å†…å®¹:"
            tail -50 build.log
            
            # æ£€æŸ¥ç‰¹å®šé”™è¯¯æ¨¡å¼
            if grep -q "error:" build.log; then
              echo "âŒ ç¼–è¯‘é”™è¯¯:"
              grep -i "error:" build.log | head -10
            fi
            
            if grep -q "undefined reference" build.log; then
              echo "âŒ é“¾æ¥é”™è¯¯:"
              grep -i "undefined reference" build.log | head -5
            fi
            
            if grep -q "conflict" build.log; then
              echo "âŒ å†²çªé”™è¯¯:"
              grep -i "conflict" build.log | head -5
            fi
          fi
          exit 1
        fi

    - name: List generated files
      run: |
        echo "ğŸ“ å·¥ä½œç›®å½•å†…å®¹:"
        ls -la
        echo "ğŸ“¦ ç”Ÿæˆçš„zipæ–‡ä»¶:"
        ls -la *.zip || echo "æ²¡æœ‰æ‰¾åˆ°zipæ–‡ä»¶"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}
        path: "*.zip"
        retention-days: 7

    - name: Debug on failure
      if: failure()
      run: |
        echo "ğŸ”§ è°ƒè¯•ä¿¡æ¯:"
        echo "å·¥ä½œç›®å½•:"
        pwd
        ls -la
        echo "æ„å»ºè„šæœ¬å†…å®¹:"
        head -50 ./build.sh
        echo "ç¯å¢ƒå˜é‡:"
        env | grep -E "(PATH|TOOLCHAIN|CCACHE)"
