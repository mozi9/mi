name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Clean workspace before checkout
      run: |
        echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ®‹ç•™æ–‡ä»¶
        sudo rm -rf $GITHUB_WORKSPACE/* $GITHUB_WORKSPACE/.* 2>/dev/null || true

    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clean build environment
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ„å»ºäº§ç‰©
        sudo rm -rf out/ anykernel/ *.zip .dts.bak/ 2>/dev/null || true
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        sudo find . -name "*.o" -delete 2>/dev/null || true
        sudo find . -name "*.cmd" -delete 2>/dev/null || true
        sudo find . -name ".tmp_*" -type d -exec rm -rf {} + 2>/dev/null || true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3 tar file

    # ç”ŸæˆçŸ­å“ˆå¸Œ
    - name: Set short commit SHA
      run: echo "SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache_mikernel
        key: ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-${{ env.SHORT_SHA }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-
          ${{ runner.os }}-ccache-

    - name: Setup zyc-clang toolchain
      run: |
        echo "ğŸ”§ è®¾ç½®å·¥å…·é“¾..."
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        cd $GITHUB_WORKSPACE
        echo "âœ… å·¥å…·é“¾è®¾ç½®å®Œæˆ"

    - name: Verify environment
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºç¯å¢ƒ..."
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        echo "ğŸ“ æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        if [ ! -f "./build.sh" ]; then
          echo "âŒ é”™è¯¯: build.sh æ–‡ä»¶ä¸å­˜åœ¨"
          echo "ğŸ’¡ è¯·ç¡®ä¿ä»“åº“åŒ…å«æ„å»ºè„šæœ¬"
          exit 1
        fi
        
        if [ ! -d "arch/arm64/configs" ]; then
          echo "âŒ é”™è¯¯: å†…æ ¸é…ç½®ç›®å½•ä¸å­˜åœ¨"
          echo "ğŸ’¡ è¯·æ£€æŸ¥ä»“åº“ç»“æ„æ˜¯å¦æ­£ç¡®"
          exit 1
        fi
        
        # æ£€æŸ¥è®¾å¤‡é…ç½®
        CONFIG_FILE="arch/arm64/configs/${{ github.event.inputs.device }}_defconfig"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: è®¾å¤‡ [${{ github.event.inputs.device }}] çš„é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          echo "ğŸ“‹ å¯ç”¨è®¾å¤‡é…ç½®:"
          ls -la arch/arm64/configs/*_defconfig 2>/dev/null | sed 's|.*/||; s|_defconfig||' || echo "   æ— å¯ç”¨é…ç½®"
          exit 1
        fi
        
        echo "âœ… ç¯å¢ƒéªŒè¯é€šè¿‡"

    - name: Build kernel
      run: |
        set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
        
        echo "ğŸš€ å¼€å§‹æ„å»ºå†…æ ¸..."
        echo "ğŸ“‹ æ„å»ºé…ç½®:"
        echo "   è®¾å¤‡: ${{ github.event.inputs.device }}"
        echo "   ç±»å‹: ${{ github.event.inputs.build_type }}"
        echo "   KSU: ${{ github.event.inputs.include_ksu }}"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export TOOLCHAIN_PATH="$HOME/zyc-clang"
        export PATH="$HOME/zyc-clang/bin:$PATH"
        
        # éªŒè¯å·¥å…·é“¾
        echo "ğŸ”§ éªŒè¯å·¥å…·é“¾..."
        if ! command -v clang >/dev/null 2>&1; then
          echo "âŒ é”™è¯¯: clang å·¥å…·é“¾æœªæ­£ç¡®è®¾ç½®"
          echo "ğŸ’¡ è¯·æ£€æŸ¥ TOOLCHAIN_PATH: $TOOLCHAIN_PATH"
          ls -la $TOOLCHAIN_PATH/bin/ 2>/dev/null || echo "å·¥å…·é“¾ç›®å½•ä¸ºç©º"
          exit 1
        fi
        
        # æ˜¾ç¤ºå·¥å…·é“¾ç‰ˆæœ¬
        echo "ğŸ“‹ å·¥å…·é“¾ä¿¡æ¯:"
        clang --version | head -1 || echo "æ— æ³•è·å–clangç‰ˆæœ¬"
        
        # æ„å»ºå‘½ä»¤å‚æ•°
        BUILD_ARGS="${{ github.event.inputs.device }}"
        
        # æ·»åŠ KSUå‚æ•°
        if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
          BUILD_ARGS="$BUILD_ARGS ksu"
        fi
        
        # æ·»åŠ æ„å»ºç±»å‹å‚æ•°
        if [ "${{ github.event.inputs.build_type }}" = "aosp" ]; then
          BUILD_ARGS="$BUILD_ARGS --aosp"
        elif [ "${{ github.event.inputs.build_type }}" = "miui" ]; then
          BUILD_ARGS="$BUILD_ARGS --miui"
        fi
        
        chmod +x ./build.sh
        
        # æ‰§è¡Œæ„å»º
        echo "ğŸ”¨ æ‰§è¡Œæ„å»ºå‘½ä»¤: ./build.sh $BUILD_ARGS"
        if ./build.sh $BUILD_ARGS; then
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ"
        else
          BUILD_EXIT_CODE=$?
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
          echo "ğŸ” è¯¦ç»†é”™è¯¯åˆ†æ:"
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯
          if [ $BUILD_EXIT_CODE -eq 1 ]; then
            echo "ğŸ’¡ é”™è¯¯ç±»å‹: å‚æ•°æˆ–é…ç½®é”™è¯¯"
            echo "   å¯èƒ½åŸå› : è®¾å¤‡é…ç½®é”™è¯¯ã€å‚æ•°ä¸åŒ¹é…"
          elif [ $BUILD_EXIT_CODE -eq 2 ]; then
            echo "ğŸ’¡ é”™è¯¯ç±»å‹: ç¼–è¯‘é”™è¯¯"
            echo "   å¯èƒ½åŸå› : ä»£ç å†²çªã€ä¾èµ–ç¼ºå¤±"
          else
            echo "ğŸ’¡ é”™è¯¯ç±»å‹: æœªçŸ¥é”™è¯¯"
          fi
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          echo "ğŸ“ æ£€æŸ¥æ„å»ºçŠ¶æ€:"
          if [ -d "out" ]; then
            echo "   out/ ç›®å½•å­˜åœ¨"
            if [ -f "out/arch/arm64/boot/Image" ]; then
              echo "   âœ… å†…æ ¸é•œåƒå·²ç”Ÿæˆ"
            else
              echo "   âŒ å†…æ ¸é•œåƒæœªç”Ÿæˆ"
            fi
          else
            echo "   âŒ out/ ç›®å½•ä¸å­˜åœ¨ï¼Œç¼–è¯‘æœªå¼€å§‹"
          fi
          
          # æ£€æŸ¥é…ç½®é—®é¢˜
          echo "ğŸ”§ æ£€æŸ¥é…ç½®çŠ¶æ€:"
          if [ -f "out/.config" ]; then
            echo "   âœ… é…ç½®å·²ç”Ÿæˆ"
            # æ£€æŸ¥å…³é”®é…ç½®
            if grep -q "CONFIG_KSU" out/.config 2>/dev/null; then
              echo "   â„¹ï¸  KSUé…ç½®å­˜åœ¨"
            fi
          else
            echo "   âŒ é…ç½®æœªç”Ÿæˆï¼Œdefconfigå¯èƒ½æœ‰é—®é¢˜"
          fi
          
          exit $BUILD_EXIT_CODE
        fi

    - name: Clean build artifacts
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
        # ä¿ç•™åˆ·æœºåŒ…ï¼Œæ¸…ç†å…¶ä»–æ–‡ä»¶
        sudo rm -rf out/ anykernel/ .dts.bak/ 2>/dev/null || true
        sudo find . -name "*.o" -delete 2>/dev/null || true
        sudo find . -name "*.cmd" -delete 2>/dev/null || true
        sudo find . -name ".tmp_*" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "ğŸ“ å‰©ä½™äº§ç‰©:"
        ls -la *.zip 2>/dev/null || echo "   æ— åˆ·æœºåŒ…æ–‡ä»¶"
        du -sh . || true

    - name: Show ccache stats
      run: ccache -s

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}-kernel
        path: |
          *.zip
        retention-days: 7

    - name: Debug info on failure
      if: failure()
      run: |
        echo "ğŸ” æ„å»ºå¤±è´¥è°ƒè¯•ä¿¡æ¯:"
        echo "ğŸ“‹ å·¥ä½œç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "ğŸ“‹ å†…æ ¸é…ç½®çŠ¶æ€:"
        if [ -f "arch/arm64/configs/${{ github.event.inputs.device }}_defconfig" ]; then
          echo "âœ… è®¾å¤‡é…ç½®å­˜åœ¨"
        else
          echo "âŒ è®¾å¤‡é…ç½®ä¸å­˜åœ¨"
        fi
        echo ""
        echo "ğŸ“‹ å·¥å…·é“¾çŠ¶æ€:"
        which clang && clang --version | head -1 || echo "clangä¸å¯ç”¨"
        echo ""
        echo "ğŸ“‹ æ„å»ºç›®å½•çŠ¶æ€:"
        if [ -d "out" ]; then
          find out -name "*.o" | head -5 | xargs file 2>/dev/null || true
        else
          echo "outç›®å½•ä¸å­˜åœ¨"
        fi

    - name: Upload error logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.device }}-error-debug
        path: |
          out/.config
          arch/arm64/configs/${{ github.event.inputs.device }}_defconfig
        retention-days: 3
      continue-on-error: true  # å³ä½¿ä¸Šä¼ å¤±è´¥ä¹Ÿä¸åœæ­¢å·¥ä½œæµ
