name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clean workspace
      run: |
        rm -rf out/ anykernel/ *.zip .dts.bak/
        find . -name "*.o" -delete 2>/dev/null || true
        find . -name "*.cmd" -delete 2>/dev/null || true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3

    - name: Setup toolchain
      run: |
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        cd $GITHUB_WORKSPACE

    - name: Build kernel
      run: |
        set -e
        
        # è®¾ç½®ç¯å¢ƒ
        export PATH="$HOME/zyc-clang/bin:$PATH"
        
        # æ„å»ºå‚æ•°
        BUILD_ARGS="${{ github.event.inputs.device }}"
        [ "${{ github.event.inputs.include_ksu }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS ksu"
        [ "${{ github.event.inputs.build_type }}" = "aosp" ] && BUILD_ARGS="$BUILD_ARGS --aosp"
        [ "${{ github.event.inputs.build_type }}" = "miui" ] && BUILD_ARGS="$BUILD_ARGS --miui"
        [ "${{ github.event.inputs.build_type }}" = "all" ] && BUILD_ARGS="$BUILD_ARGS --aosp --miui"
        
        chmod +x ./build.sh
        
        # æ‰§è¡Œæ„å»º
        echo "ğŸš€ å¼€å§‹æ„å»ºå†…æ ¸..."
        ./build.sh $BUILD_ARGS
        
        echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}
        path: "*.zip"
        retention-days: 7

    - name: Cleanup on failure
      if: failure()
      run: |
        echo "âŒ æ„å»ºå¤±è´¥"
        # ç®€å•çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        if [ -f build.log ]; then
          echo "ğŸ“‹ æœ€åå‡ è¡Œæ„å»ºæ—¥å¿—:"
          tail -20 build.log || true
        fi
