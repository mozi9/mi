name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡ä»£å·'
        required: true
        default: 'alioth'
        type: choice
        options:
          - psyche
          - umi
          - munch
          - lmi
          - cmi
          - cas
          - apollo
          - alioth
          - elish
          - enuma
          - dagu
          - pipa
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'miui'
        type: choice
        options:
          - 'aosp'
          - 'miui'
          - 'all'
      include_ksu:
        description: 'æ˜¯å¦åŒ…å«KSU'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clean previous build artifacts
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©..."
        rm -rf out/ anykernel/ *.zip .dts.bak/ 2>/dev/null || true
        find . -name "*.o" -delete 2>/dev/null || true
        find . -name "*.cmd" -delete 2>/dev/null || true
        find . -name ".tmp_*" -type d -exec rm -rf {} + 2>/dev/null || true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache python-is-python3 tar file

    - name: Set short commit SHA
      run: echo "SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache_mikernel
        key: ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-${{ env.SHORT_SHA }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-${{ github.event.inputs.include_ksu }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}-
          ${{ runner.os }}-ccache-${{ github.event.inputs.device }}-
          ${{ runner.os }}-ccache-

    - name: Setup zyc-clang toolchain
      run: |
        echo "ğŸ”§ è®¾ç½®å·¥å…·é“¾..."
        mkdir -p $HOME/zyc-clang
        cd $HOME/zyc-clang
        wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
        tar -zxf Clang-15.0.7-20251111.tar.gz
        cd $GITHUB_WORKSPACE

    - name: Pre-check common conflict files
      run: |
        echo "ğŸ” é¢„æ£€æŸ¥29ä¸ªå¸¸è§å†²çªæ–‡ä»¶..."
        
        # å®šä¹‰å¸¸è§å†²çªæ–‡ä»¶åˆ—è¡¨
        CONFLICT_FILES=(
          "drivers/Makefile"
          "drivers/input/input.c"
          "drivers/tty/pty.c"
          "fs/Makefile"
          "fs/dcache.c"
          "fs/exec.c"
          "fs/namei.c"
          "fs/namespace.c"
          "fs/notify/fdinfo.c"
          "fs/open.c"
          "fs/overlayfs/inode.c"
          "fs/overlayfs/readdir.c"
          "fs/overlayfs/super.c"
          "fs/proc/cmdline.c"
          "fs/proc/fd.c"
          "fs/proc/task_mmu.c"
          "fs/proc_namespace.c"
          "fs/read_write.c"
          "fs/readdir.c"
          "fs/stat.c"
          "fs/statfs.c"
          "fs/susfs.c"
          "include/linux/mount.h"
          "include/linux/sched.h"
          "include/linux/susfs.h"
          "include/linux/susfs_def.h"
          "kernel/kallsyms.c"
          "kernel/sys.c"
          "security/selinux/avc.c"
        )
        
        echo "ğŸ“‹ æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§å’Œå†²çªæ ‡è®°..."
        
        for file in "${CONFLICT_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo -n "âœ… $file - å­˜åœ¨"
            
            # æ£€æŸ¥å¸¸è§çš„å†²çªæ ‡è®°
            if grep -q "<<<<<<<" "$file" || grep -q ">>>>>>>" "$file"; then
              echo " âŒ å‘ç°Gitå†²çªæ ‡è®°!"
              echo "   å†²çªä½ç½®:"
              grep -n "<<<<<<<" "$file" | head -3
            elif grep -q "CONFIG_" "$file" && grep -q "#ifdef" "$file"; then
              echo " âš ï¸ å¯èƒ½åŒ…å«é…ç½®å†²çª"
            else
              echo " âœ… æ— å†²çªæ ‡è®°"
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œä¿®æ”¹æ—¶é—´
            file_info=$(ls -la "$file" | awk '{print $5, $6, $7, $8}')
            echo "   ä¿¡æ¯: $file_info"
            
          else
            echo "âŒ $file - æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        done
        
        echo ""
        echo "ğŸ”§ æ£€æŸ¥KernelSUé›†æˆ..."
        if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
          if [ -d "drivers/kernelsu" ] || [ -d "KernelSU" ]; then
            echo "âœ… KernelSUç›®å½•å­˜åœ¨"
            # æ£€æŸ¥KSUç›¸å…³çš„ä¿®æ”¹
            if grep -r "kernelsu" drivers/Makefile 2>/dev/null || grep -r "kernelsu" fs/Makefile 2>/dev/null; then
              echo "âœ… KernelSUå·²é›†æˆåˆ°Makefile"
            else
              echo "âš ï¸ KernelSUå¯èƒ½æœªæ­£ç¡®é›†æˆåˆ°Makefile"
            fi
          else
            echo "âŒ KernelSUç›®å½•ä¸å­˜åœ¨"
          fi
        fi

    - name: Build kernel with detailed conflict detection
      run: |
        set -e
        
        echo "ğŸš€ å¼€å§‹æ„å»ºå†…æ ¸..."
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export TOOLCHAIN_PATH="$HOME/zyc-clang"
        export PATH="$HOME/zyc-clang/bin:$PATH"
        
        # æ„å»ºå‘½ä»¤å‚æ•°
        BUILD_ARGS="${{ github.event.inputs.device }}"
        [ "${{ github.event.inputs.include_ksu }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS ksu"
        [ "${{ github.event.inputs.build_type }}" = "aosp" ] && BUILD_ARGS="$BUILD_ARGS --aosp"
        [ "${{ github.event.inputs.build_type }}" = "miui" ] && BUILD_ARGS="$BUILD_ARGS --miui"
        [ "${{ github.event.inputs.build_type }}" = "all" ] && BUILD_ARGS="$BUILD_ARGS --aosp --miui"
        
        chmod +x ./build.sh
        
        # æ‰§è¡Œæ„å»ºå¹¶æ•è·è¾“å‡º
        if ! ./build.sh $BUILD_ARGS 2>&1 | tee build_output.log; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œåˆ†æ29ä¸ªå¸¸è§æ–‡ä»¶çš„å†²çª..."
          
          # å®šä¹‰å¸¸è§å†²çªæ–‡ä»¶
          CONFLICT_FILES=(
            "drivers/Makefile" "drivers/input/input.c" "drivers/tty/pty.c"
            "fs/Makefile" "fs/dcache.c" "fs/exec.c" "fs/namei.c" "fs/namespace.c"
            "fs/notify/fdinfo.c" "fs/open.c" "fs/overlayfs/inode.c" "fs/overlayfs/readdir.c"
            "fs/overlayfs/super.c" "fs/proc/cmdline.c" "fs/proc/fd.c" "fs/proc/task_mmu.c"
            "fs/proc_namespace.c" "fs/read_write.c" "fs/readdir.c" "fs/stat.c"
            "fs/statfs.c" "fs/susfs.c" "include/linux/mount.h" "include/linux/sched.h"
            "include/linux/susfs.h" "include/linux/susfs_def.h" "kernel/kallsyms.c"
            "kernel/sys.c" "security/selinux/avc.c"
          )
          
          # åˆ†ææ¯ä¸ªæ–‡ä»¶çš„é”™è¯¯
          for file in "${CONFLICT_FILES[@]}"; do
            if grep -q "$file" build_output.log; then
              echo ""
              echo "ğŸ” æ–‡ä»¶ $file å‘ç°é”™è¯¯:"
              
              # æå–è¯¥æ–‡ä»¶ç›¸å…³çš„é”™è¯¯ä¿¡æ¯
              grep -A 3 -B 3 "$file" build_output.log | head -10
              
              # æ£€æŸ¥æ–‡ä»¶ä¸­çš„å…·ä½“é—®é¢˜
              if [ -f "$file" ]; then
                echo "ğŸ“„ æ–‡ä»¶å†…å®¹æ£€æŸ¥:"
                
                # æ£€æŸ¥Gitå†²çªæ ‡è®°
                if grep -q "<<<<<<<" "$file"; then
                  echo "âŒ å‘ç°Gitå†²çªæ ‡è®°:"
                  grep -n "<<<<<<<" "$file" | head -2
                fi
                
                # æ£€æŸ¥è¯­æ³•é”™è¯¯
                if echo "$file" | grep -q "\.c$"; then
                  echo "ğŸ”§ å°è¯•è¯­æ³•æ£€æŸ¥:"
                  gcc -fsyntax-only -Iinclude -Iarch/arm64/include "$file" 2>&1 | head -5 || true
                fi
                
                # æ£€æŸ¥å¤´æ–‡ä»¶åŒ…å«
                if grep -q "#include" "$file"; then
                  missing_includes=$(grep "#include" "$file" | while read inc; do
                    header=$(echo "$inc" | sed 's/.*#include *[<"]\([^>"]*\)[>"].*/\1/')
                    if [ ! -f "include/$header" ] && [ ! -f "arch/arm64/include/$header" ]; then
                      echo "å¯èƒ½ç¼ºå¤±: $header"
                    fi
                  done)
                  if [ -n "$missing_includes" ]; then
                    echo "âš ï¸ å¤´æ–‡ä»¶é—®é¢˜:"
                    echo "$missing_includes" | head -3
                  fi
                fi
              fi
            fi
          done
          
          # æ£€æŸ¥å¸¸è§çš„é”™è¯¯æ¨¡å¼
          echo ""
          echo "ğŸ”§ å¸¸è§é”™è¯¯æ¨¡å¼åˆ†æ:"
          
          # 1. å‡½æ•°é‡å¤å®šä¹‰
          if grep -q "redefinition of" build_output.log; then
            echo "âŒ å‡½æ•°é‡å¤å®šä¹‰:"
            grep "redefinition of" build_output.log | head -3
          fi
          
          # 2. æœªå®šä¹‰çš„å¼•ç”¨
          if grep -q "undefined reference to" build_output.log; then
            echo "âŒ æœªå®šä¹‰çš„å¼•ç”¨:"
            grep "undefined reference to" build_output.log | head -3
          fi
          
          # 3. ç±»å‹å†²çª
          if grep -q "conflicting types for" build_output.log; then
            echo "âŒ ç±»å‹å†²çª:"
            grep -A 2 -B 2 "conflicting types for" build_output.log | head -5
          fi
          
          # 4. Makefileé”™è¯¯
          if grep -q "Makefile:" build_output.log; then
            echo "âŒ Makefileé”™è¯¯:"
            grep -A 2 "Makefile:" build_output.log | head -5
          fi
          
          # 5. ç¼ºå°‘å£°æ˜
          if grep -q "implicit declaration" build_output.log; then
            echo "âŒ éšå¼å£°æ˜è­¦å‘Š:"
            grep "implicit declaration" build_output.log | head -3
          fi
          
          # æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯æ–‡ä»¶å’Œè¡Œå·
          echo ""
          echo "ğŸ“ é”™è¯¯ç²¾ç¡®å®šä½:"
          grep -E "error:|warning:" build_output.log | head -10 | while read error_line; do
            if echo "$error_line" | grep -q ":[0-9]*:[0-9]*:"; then
              file_path=$(echo "$error_line" | cut -d: -f1)
              line_num=$(echo "$error_line" | cut -d: -f2)
              error_msg=$(echo "$error_line" | cut -d: -f4-)
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯29ä¸ªå¸¸è§æ–‡ä»¶ä¹‹ä¸€
              for conflict_file in "${CONFLICT_FILES[@]}"; do
                if [ "$file_path" = "$conflict_file" ]; then
                  echo "ğŸ¯ é‡ç‚¹æ–‡ä»¶: $file_path:$line_num"
                  echo "   ğŸ’¬ $error_msg"
                  
                  # æ˜¾ç¤ºé”™è¯¯ä¸Šä¸‹æ–‡
                  if [ -f "$file_path" ] && [ -n "$line_num" ]; then
                    echo "   ğŸ“ ä»£ç ä¸Šä¸‹æ–‡:"
                    sed -n "$((line_num-2)),$((line_num+2))p" "$file_path" 2>/dev/null | while read code; do
                      echo "      $code"
                    done
                  fi
                  break
                fi
              done
            fi
          done
          
          echo ""
          echo "ğŸ’¡ è§£å†³å»ºè®®:"
          echo "1. æ£€æŸ¥ä¸Šè¿°29ä¸ªæ–‡ä»¶ä¸­çš„Gitå†²çªæ ‡è®° (<<<<<<<, >>>>>>>)"
          echo "2. éªŒè¯å‡½æ•°å£°æ˜å’Œå®šä¹‰æ˜¯å¦ä¸€è‡´"
          echo "3. æ£€æŸ¥å¤´æ–‡ä»¶åŒ…å«æ˜¯å¦æ­£ç¡®"
          echo "4. ç¡®è®¤KernelSUé›†æˆæ˜¯å¦å®Œæ•´"
          echo "5. æŸ¥çœ‹å…·ä½“çš„é”™è¯¯æ–‡ä»¶å’Œè¡Œå·è¿›è¡Œä¿®å¤"
          
          exit 1
        fi
        
        echo "âœ… æ„å»ºæˆåŠŸ"

    - name: Check build artifacts
      if: success()
      run: |
        echo "ğŸ“¦ æ£€æŸ¥æ„å»ºäº§ç‰©..."
        if ls *.zip 1> /dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ°åˆ·æœºåŒ…:"
          ls -lh *.zip
        else
          echo "âŒ æœªæ‰¾åˆ°åˆ·æœºåŒ…"
          exit 1
        fi

    - name: Clean build artifacts
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
        rm -rf build_output.log 2>/dev/null || true
        if [ "${{ success() }}" = "true" ]; then
          rm -rf out/ anykernel/ .dts.bak/ 2>/dev/null || true
          find . -name "*.o" -delete 2>/dev/null || true
          find . -name "*.cmd" -delete 2>/dev/null || true
        fi

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.device }}-${{ github.event.inputs.build_type }}${{ github.event.inputs.include_ksu == 'true' && '-ksu' || '' }}-kernel
        path: |
          *.zip
        retention-days: 7
